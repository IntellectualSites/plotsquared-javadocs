<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (17) -->
<title>Source code</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="source: package: com.plotsquared.core, class: PlotSquared">
<meta name="generator" content="javadoc/SourceToHTMLConverter">
<link rel="stylesheet" type="text/css" href="../../../../stylesheet.css" title="Style">
</head>
<body class="source-page">
<main role="main">
<div class="source-container">
<pre><span class="source-line-no">001</span><span id="line-1">/*</span>
<span class="source-line-no">002</span><span id="line-2"> * PlotSquared, a land and world management plugin for Minecraft.</span>
<span class="source-line-no">003</span><span id="line-3"> * Copyright (C) IntellectualSites &lt;https://intellectualsites.com&gt;</span>
<span class="source-line-no">004</span><span id="line-4"> * Copyright (C) IntellectualSites team and contributors</span>
<span class="source-line-no">005</span><span id="line-5"> *</span>
<span class="source-line-no">006</span><span id="line-6"> * This program is free software: you can redistribute it and/or modify</span>
<span class="source-line-no">007</span><span id="line-7"> * it under the terms of the GNU General Public License as published by</span>
<span class="source-line-no">008</span><span id="line-8"> * the Free Software Foundation, either version 3 of the License, or</span>
<span class="source-line-no">009</span><span id="line-9"> * (at your option) any later version.</span>
<span class="source-line-no">010</span><span id="line-10"> *</span>
<span class="source-line-no">011</span><span id="line-11"> * This program is distributed in the hope that it will be useful,</span>
<span class="source-line-no">012</span><span id="line-12"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="source-line-no">013</span><span id="line-13"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="source-line-no">014</span><span id="line-14"> * GNU General Public License for more details.</span>
<span class="source-line-no">015</span><span id="line-15"> *</span>
<span class="source-line-no">016</span><span id="line-16"> * You should have received a copy of the GNU General Public License</span>
<span class="source-line-no">017</span><span id="line-17"> * along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="source-line-no">018</span><span id="line-18"> */</span>
<span class="source-line-no">019</span><span id="line-19">package com.plotsquared.core;</span>
<span class="source-line-no">020</span><span id="line-20"></span>
<span class="source-line-no">021</span><span id="line-21">import com.plotsquared.core.configuration.ConfigurationSection;</span>
<span class="source-line-no">022</span><span id="line-22">import com.plotsquared.core.configuration.ConfigurationUtil;</span>
<span class="source-line-no">023</span><span id="line-23">import com.plotsquared.core.configuration.MemorySection;</span>
<span class="source-line-no">024</span><span id="line-24">import com.plotsquared.core.configuration.Settings;</span>
<span class="source-line-no">025</span><span id="line-25">import com.plotsquared.core.configuration.Storage;</span>
<span class="source-line-no">026</span><span id="line-26">import com.plotsquared.core.configuration.caption.CaptionMap;</span>
<span class="source-line-no">027</span><span id="line-27">import com.plotsquared.core.configuration.caption.DummyCaptionMap;</span>
<span class="source-line-no">028</span><span id="line-28">import com.plotsquared.core.configuration.caption.TranslatableCaption;</span>
<span class="source-line-no">029</span><span id="line-29">import com.plotsquared.core.configuration.caption.load.CaptionLoader;</span>
<span class="source-line-no">030</span><span id="line-30">import com.plotsquared.core.configuration.caption.load.DefaultCaptionProvider;</span>
<span class="source-line-no">031</span><span id="line-31">import com.plotsquared.core.configuration.file.YamlConfiguration;</span>
<span class="source-line-no">032</span><span id="line-32">import com.plotsquared.core.configuration.serialization.ConfigurationSerialization;</span>
<span class="source-line-no">033</span><span id="line-33">import com.plotsquared.core.database.DBFunc;</span>
<span class="source-line-no">034</span><span id="line-34">import com.plotsquared.core.database.Database;</span>
<span class="source-line-no">035</span><span id="line-35">import com.plotsquared.core.database.MySQL;</span>
<span class="source-line-no">036</span><span id="line-36">import com.plotsquared.core.database.SQLManager;</span>
<span class="source-line-no">037</span><span id="line-37">import com.plotsquared.core.database.SQLite;</span>
<span class="source-line-no">038</span><span id="line-38">import com.plotsquared.core.generator.GeneratorWrapper;</span>
<span class="source-line-no">039</span><span id="line-39">import com.plotsquared.core.generator.HybridPlotWorld;</span>
<span class="source-line-no">040</span><span id="line-40">import com.plotsquared.core.generator.HybridUtils;</span>
<span class="source-line-no">041</span><span id="line-41">import com.plotsquared.core.generator.IndependentPlotGenerator;</span>
<span class="source-line-no">042</span><span id="line-42">import com.plotsquared.core.inject.factory.HybridPlotWorldFactory;</span>
<span class="source-line-no">043</span><span id="line-43">import com.plotsquared.core.listener.PlotListener;</span>
<span class="source-line-no">044</span><span id="line-44">import com.plotsquared.core.location.Location;</span>
<span class="source-line-no">045</span><span id="line-45">import com.plotsquared.core.player.PlayerMetaDataKeys;</span>
<span class="source-line-no">046</span><span id="line-46">import com.plotsquared.core.plot.BlockBucket;</span>
<span class="source-line-no">047</span><span id="line-47">import com.plotsquared.core.plot.Plot;</span>
<span class="source-line-no">048</span><span id="line-48">import com.plotsquared.core.plot.PlotArea;</span>
<span class="source-line-no">049</span><span id="line-49">import com.plotsquared.core.plot.PlotAreaTerrainType;</span>
<span class="source-line-no">050</span><span id="line-50">import com.plotsquared.core.plot.PlotAreaType;</span>
<span class="source-line-no">051</span><span id="line-51">import com.plotsquared.core.plot.PlotCluster;</span>
<span class="source-line-no">052</span><span id="line-52">import com.plotsquared.core.plot.PlotId;</span>
<span class="source-line-no">053</span><span id="line-53">import com.plotsquared.core.plot.PlotManager;</span>
<span class="source-line-no">054</span><span id="line-54">import com.plotsquared.core.plot.expiration.ExpireManager;</span>
<span class="source-line-no">055</span><span id="line-55">import com.plotsquared.core.plot.expiration.ExpiryTask;</span>
<span class="source-line-no">056</span><span id="line-56">import com.plotsquared.core.plot.flag.GlobalFlagContainer;</span>
<span class="source-line-no">057</span><span id="line-57">import com.plotsquared.core.plot.world.PlotAreaManager;</span>
<span class="source-line-no">058</span><span id="line-58">import com.plotsquared.core.plot.world.SinglePlotArea;</span>
<span class="source-line-no">059</span><span id="line-59">import com.plotsquared.core.plot.world.SinglePlotAreaManager;</span>
<span class="source-line-no">060</span><span id="line-60">import com.plotsquared.core.util.EventDispatcher;</span>
<span class="source-line-no">061</span><span id="line-61">import com.plotsquared.core.util.FileUtils;</span>
<span class="source-line-no">062</span><span id="line-62">import com.plotsquared.core.util.LegacyConverter;</span>
<span class="source-line-no">063</span><span id="line-63">import com.plotsquared.core.util.MathMan;</span>
<span class="source-line-no">064</span><span id="line-64">import com.plotsquared.core.util.ReflectionUtils;</span>
<span class="source-line-no">065</span><span id="line-65">import com.plotsquared.core.util.task.TaskManager;</span>
<span class="source-line-no">066</span><span id="line-66">import com.plotsquared.core.uuid.UUIDPipeline;</span>
<span class="source-line-no">067</span><span id="line-67">import com.sk89q.worldedit.WorldEdit;</span>
<span class="source-line-no">068</span><span id="line-68">import com.sk89q.worldedit.event.platform.PlatformReadyEvent;</span>
<span class="source-line-no">069</span><span id="line-69">import com.sk89q.worldedit.math.BlockVector2;</span>
<span class="source-line-no">070</span><span id="line-70">import com.sk89q.worldedit.util.eventbus.EventHandler;</span>
<span class="source-line-no">071</span><span id="line-71">import com.sk89q.worldedit.util.eventbus.Subscribe;</span>
<span class="source-line-no">072</span><span id="line-72">import org.apache.logging.log4j.LogManager;</span>
<span class="source-line-no">073</span><span id="line-73">import org.apache.logging.log4j.Logger;</span>
<span class="source-line-no">074</span><span id="line-74">import org.checkerframework.checker.nullness.qual.MonotonicNonNull;</span>
<span class="source-line-no">075</span><span id="line-75">import org.checkerframework.checker.nullness.qual.NonNull;</span>
<span class="source-line-no">076</span><span id="line-76">import org.checkerframework.checker.nullness.qual.Nullable;</span>
<span class="source-line-no">077</span><span id="line-77"></span>
<span class="source-line-no">078</span><span id="line-78">import java.io.BufferedReader;</span>
<span class="source-line-no">079</span><span id="line-79">import java.io.File;</span>
<span class="source-line-no">080</span><span id="line-80">import java.io.FileInputStream;</span>
<span class="source-line-no">081</span><span id="line-81">import java.io.FileOutputStream;</span>
<span class="source-line-no">082</span><span id="line-82">import java.io.IOException;</span>
<span class="source-line-no">083</span><span id="line-83">import java.io.InputStream;</span>
<span class="source-line-no">084</span><span id="line-84">import java.io.InputStreamReader;</span>
<span class="source-line-no">085</span><span id="line-85">import java.io.ObjectInputStream;</span>
<span class="source-line-no">086</span><span id="line-86">import java.io.ObjectOutputStream;</span>
<span class="source-line-no">087</span><span id="line-87">import java.net.MalformedURLException;</span>
<span class="source-line-no">088</span><span id="line-88">import java.net.URISyntaxException;</span>
<span class="source-line-no">089</span><span id="line-89">import java.net.URL;</span>
<span class="source-line-no">090</span><span id="line-90">import java.nio.file.Files;</span>
<span class="source-line-no">091</span><span id="line-91">import java.nio.file.StandardOpenOption;</span>
<span class="source-line-no">092</span><span id="line-92">import java.sql.SQLException;</span>
<span class="source-line-no">093</span><span id="line-93">import java.util.ArrayDeque;</span>
<span class="source-line-no">094</span><span id="line-94">import java.util.ArrayList;</span>
<span class="source-line-no">095</span><span id="line-95">import java.util.Arrays;</span>
<span class="source-line-no">096</span><span id="line-96">import java.util.Collection;</span>
<span class="source-line-no">097</span><span id="line-97">import java.util.Collections;</span>
<span class="source-line-no">098</span><span id="line-98">import java.util.Comparator;</span>
<span class="source-line-no">099</span><span id="line-99">import java.util.HashMap;</span>
<span class="source-line-no">100</span><span id="line-100">import java.util.HashSet;</span>
<span class="source-line-no">101</span><span id="line-101">import java.util.Iterator;</span>
<span class="source-line-no">102</span><span id="line-102">import java.util.List;</span>
<span class="source-line-no">103</span><span id="line-103">import java.util.Locale;</span>
<span class="source-line-no">104</span><span id="line-104">import java.util.Map;</span>
<span class="source-line-no">105</span><span id="line-105">import java.util.Map.Entry;</span>
<span class="source-line-no">106</span><span id="line-106">import java.util.Objects;</span>
<span class="source-line-no">107</span><span id="line-107">import java.util.Set;</span>
<span class="source-line-no">108</span><span id="line-108">import java.util.concurrent.Executors;</span>
<span class="source-line-no">109</span><span id="line-109">import java.util.function.Consumer;</span>
<span class="source-line-no">110</span><span id="line-110">import java.util.regex.Pattern;</span>
<span class="source-line-no">111</span><span id="line-111">import java.util.zip.ZipEntry;</span>
<span class="source-line-no">112</span><span id="line-112">import java.util.zip.ZipInputStream;</span>
<span class="source-line-no">113</span><span id="line-113"></span>
<span class="source-line-no">114</span><span id="line-114">/**</span>
<span class="source-line-no">115</span><span id="line-115"> * An implementation of the core, with a static getter for easy access.</span>
<span class="source-line-no">116</span><span id="line-116"> */</span>
<span class="source-line-no">117</span><span id="line-117">@SuppressWarnings({"WeakerAccess"})</span>
<span class="source-line-no">118</span><span id="line-118">public class PlotSquared {</span>
<span class="source-line-no">119</span><span id="line-119"></span>
<span class="source-line-no">120</span><span id="line-120">    private static final Logger LOGGER = LogManager.getLogger("PlotSquared/" + PlotSquared.class.getSimpleName());</span>
<span class="source-line-no">121</span><span id="line-121">    private static @MonotonicNonNull PlotSquared instance;</span>
<span class="source-line-no">122</span><span id="line-122"></span>
<span class="source-line-no">123</span><span id="line-123">    // Implementation</span>
<span class="source-line-no">124</span><span id="line-124">    private final PlotPlatform&lt;?&gt; platform;</span>
<span class="source-line-no">125</span><span id="line-125">    // Current thread</span>
<span class="source-line-no">126</span><span id="line-126">    private final Thread thread;</span>
<span class="source-line-no">127</span><span id="line-127">    // UUID pipelines</span>
<span class="source-line-no">128</span><span id="line-128">    private final UUIDPipeline impromptuUUIDPipeline =</span>
<span class="source-line-no">129</span><span id="line-129">            new UUIDPipeline(Executors.newCachedThreadPool());</span>
<span class="source-line-no">130</span><span id="line-130">    private final UUIDPipeline backgroundUUIDPipeline =</span>
<span class="source-line-no">131</span><span id="line-131">            new UUIDPipeline(Executors.newSingleThreadExecutor());</span>
<span class="source-line-no">132</span><span id="line-132">    // Localization</span>
<span class="source-line-no">133</span><span id="line-133">    private final Map&lt;String, CaptionMap&gt; captionMaps = new HashMap&lt;&gt;();</span>
<span class="source-line-no">134</span><span id="line-134">    public HashMap&lt;String, HashMap&lt;PlotId, Plot&gt;&gt; plots_tmp;</span>
<span class="source-line-no">135</span><span id="line-135">    private CaptionLoader captionLoader;</span>
<span class="source-line-no">136</span><span id="line-136">    // WorldEdit instance</span>
<span class="source-line-no">137</span><span id="line-137">    private WorldEdit worldedit;</span>
<span class="source-line-no">138</span><span id="line-138">    private File configFile;</span>
<span class="source-line-no">139</span><span id="line-139">    private File worldsFile;</span>
<span class="source-line-no">140</span><span id="line-140">    private YamlConfiguration worldConfiguration;</span>
<span class="source-line-no">141</span><span id="line-141">    // Temporary hold the plots/clusters before the worlds load</span>
<span class="source-line-no">142</span><span id="line-142">    private HashMap&lt;String, Set&lt;PlotCluster&gt;&gt; clustersTmp;</span>
<span class="source-line-no">143</span><span id="line-143">    private YamlConfiguration config;</span>
<span class="source-line-no">144</span><span id="line-144">    // Platform / Version / Update URL</span>
<span class="source-line-no">145</span><span id="line-145">    private PlotVersion version;</span>
<span class="source-line-no">146</span><span id="line-146">    // Files and configuration</span>
<span class="source-line-no">147</span><span id="line-147">    private File jarFile = null; // This file</span>
<span class="source-line-no">148</span><span id="line-148">    private File storageFile;</span>
<span class="source-line-no">149</span><span id="line-149">    private EventDispatcher eventDispatcher;</span>
<span class="source-line-no">150</span><span id="line-150">    private PlotListener plotListener;</span>
<span class="source-line-no">151</span><span id="line-151"></span>
<span class="source-line-no">152</span><span id="line-152">    private boolean weInitialised;</span>
<span class="source-line-no">153</span><span id="line-153"></span>
<span class="source-line-no">154</span><span id="line-154">    /**</span>
<span class="source-line-no">155</span><span id="line-155">     * Initialize PlotSquared with the desired Implementation class.</span>
<span class="source-line-no">156</span><span id="line-156">     *</span>
<span class="source-line-no">157</span><span id="line-157">     * @param iPlotMain Implementation of {@link PlotPlatform} used</span>
<span class="source-line-no">158</span><span id="line-158">     * @param platform  The platform being used</span>
<span class="source-line-no">159</span><span id="line-159">     */</span>
<span class="source-line-no">160</span><span id="line-160">    public PlotSquared(</span>
<span class="source-line-no">161</span><span id="line-161">            final @NonNull PlotPlatform&lt;?&gt; iPlotMain,</span>
<span class="source-line-no">162</span><span id="line-162">            final @NonNull String platform</span>
<span class="source-line-no">163</span><span id="line-163">    ) {</span>
<span class="source-line-no">164</span><span id="line-164">        if (instance != null) {</span>
<span class="source-line-no">165</span><span id="line-165">            throw new IllegalStateException("Cannot re-initialize the PlotSquared singleton");</span>
<span class="source-line-no">166</span><span id="line-166">        }</span>
<span class="source-line-no">167</span><span id="line-167">        instance = this;</span>
<span class="source-line-no">168</span><span id="line-168"></span>
<span class="source-line-no">169</span><span id="line-169">        this.thread = Thread.currentThread();</span>
<span class="source-line-no">170</span><span id="line-170">        this.platform = iPlotMain;</span>
<span class="source-line-no">171</span><span id="line-171">        Settings.PLATFORM = platform;</span>
<span class="source-line-no">172</span><span id="line-172"></span>
<span class="source-line-no">173</span><span id="line-173">        // Initialize the class</span>
<span class="source-line-no">174</span><span id="line-174">        PlayerMetaDataKeys.load();</span>
<span class="source-line-no">175</span><span id="line-175"></span>
<span class="source-line-no">176</span><span id="line-176">        //</span>
<span class="source-line-no">177</span><span id="line-177">        // Register configuration serializable classes</span>
<span class="source-line-no">178</span><span id="line-178">        //</span>
<span class="source-line-no">179</span><span id="line-179">        ConfigurationSerialization.registerClass(BlockBucket.class, "BlockBucket");</span>
<span class="source-line-no">180</span><span id="line-180"></span>
<span class="source-line-no">181</span><span id="line-181">        // load configs before reading from settings</span>
<span class="source-line-no">182</span><span id="line-182">        if (!setupConfigs()) {</span>
<span class="source-line-no">183</span><span id="line-183">            return;</span>
<span class="source-line-no">184</span><span id="line-184">        }</span>
<span class="source-line-no">185</span><span id="line-185"></span>
<span class="source-line-no">186</span><span id="line-186">        this.captionLoader = CaptionLoader.of(</span>
<span class="source-line-no">187</span><span id="line-187">                Locale.ENGLISH,</span>
<span class="source-line-no">188</span><span id="line-188">                CaptionLoader.patternExtractor(Pattern.compile("messages_(.*)\\.json")),</span>
<span class="source-line-no">189</span><span id="line-189">                DefaultCaptionProvider.forClassLoaderFormatString(</span>
<span class="source-line-no">190</span><span id="line-190">                        this.getClass().getClassLoader(),</span>
<span class="source-line-no">191</span><span id="line-191">                        "lang/messages_%s.json" // the path in our jar file</span>
<span class="source-line-no">192</span><span id="line-192">                ),</span>
<span class="source-line-no">193</span><span id="line-193">                TranslatableCaption.DEFAULT_NAMESPACE</span>
<span class="source-line-no">194</span><span id="line-194">        );</span>
<span class="source-line-no">195</span><span id="line-195">        // Load caption map</span>
<span class="source-line-no">196</span><span id="line-196">        try {</span>
<span class="source-line-no">197</span><span id="line-197">            this.loadCaptionMap();</span>
<span class="source-line-no">198</span><span id="line-198">        } catch (final Exception e) {</span>
<span class="source-line-no">199</span><span id="line-199">            LOGGER.error("Failed to load caption map", e);</span>
<span class="source-line-no">200</span><span id="line-200">            LOGGER.error("Shutting down server to prevent further issues");</span>
<span class="source-line-no">201</span><span id="line-201">            this.platform.shutdownServer();</span>
<span class="source-line-no">202</span><span id="line-202">            throw new RuntimeException("Abort loading PlotSquared");</span>
<span class="source-line-no">203</span><span id="line-203">        }</span>
<span class="source-line-no">204</span><span id="line-204"></span>
<span class="source-line-no">205</span><span id="line-205">        // Setup the global flag container</span>
<span class="source-line-no">206</span><span id="line-206">        GlobalFlagContainer.setup();</span>
<span class="source-line-no">207</span><span id="line-207"></span>
<span class="source-line-no">208</span><span id="line-208">        try {</span>
<span class="source-line-no">209</span><span id="line-209">            new ReflectionUtils(this.platform.serverNativePackage());</span>
<span class="source-line-no">210</span><span id="line-210">            try {</span>
<span class="source-line-no">211</span><span id="line-211">                URL logurl = PlotSquared.class.getProtectionDomain().getCodeSource().getLocation();</span>
<span class="source-line-no">212</span><span id="line-212">                this.jarFile = new File(</span>
<span class="source-line-no">213</span><span id="line-213">                        new URL(logurl.toURI().toString().split("\\!")[0].replaceAll("jar:file", "file"))</span>
<span class="source-line-no">214</span><span id="line-214">                                .toURI().getPath());</span>
<span class="source-line-no">215</span><span id="line-215">            } catch (MalformedURLException | URISyntaxException | SecurityException e) {</span>
<span class="source-line-no">216</span><span id="line-216">                e.printStackTrace();</span>
<span class="source-line-no">217</span><span id="line-217">                this.jarFile = new File(this.platform.getDirectory().getParentFile(), "PlotSquared.jar");</span>
<span class="source-line-no">218</span><span id="line-218">                if (!this.jarFile.exists()) {</span>
<span class="source-line-no">219</span><span id="line-219">                    this.jarFile = new File(</span>
<span class="source-line-no">220</span><span id="line-220">                            this.platform.getDirectory().getParentFile(),</span>
<span class="source-line-no">221</span><span id="line-221">                            "PlotSquared-" + platform + ".jar"</span>
<span class="source-line-no">222</span><span id="line-222">                    );</span>
<span class="source-line-no">223</span><span id="line-223">                }</span>
<span class="source-line-no">224</span><span id="line-224">            }</span>
<span class="source-line-no">225</span><span id="line-225"></span>
<span class="source-line-no">226</span><span id="line-226">            this.worldedit = WorldEdit.getInstance();</span>
<span class="source-line-no">227</span><span id="line-227">            WorldEdit.getInstance().getEventBus().register(new WEPlatformReadyListener());</span>
<span class="source-line-no">228</span><span id="line-228"></span>
<span class="source-line-no">229</span><span id="line-229">            // Create Event utility class</span>
<span class="source-line-no">230</span><span id="line-230">            this.eventDispatcher = new EventDispatcher(this.worldedit);</span>
<span class="source-line-no">231</span><span id="line-231">            // Create plot listener</span>
<span class="source-line-no">232</span><span id="line-232">            this.plotListener = new PlotListener(this.eventDispatcher);</span>
<span class="source-line-no">233</span><span id="line-233"></span>
<span class="source-line-no">234</span><span id="line-234">            // Copy files</span>
<span class="source-line-no">235</span><span id="line-235">            copyFile("town.template", Settings.Paths.TEMPLATES);</span>
<span class="source-line-no">236</span><span id="line-236">            copyFile("bridge.template", Settings.Paths.TEMPLATES);</span>
<span class="source-line-no">237</span><span id="line-237">            copyFile("skyblock.template", Settings.Paths.TEMPLATES);</span>
<span class="source-line-no">238</span><span id="line-238">            showDebug();</span>
<span class="source-line-no">239</span><span id="line-239">        } catch (Throwable e) {</span>
<span class="source-line-no">240</span><span id="line-240">            e.printStackTrace();</span>
<span class="source-line-no">241</span><span id="line-241">        }</span>
<span class="source-line-no">242</span><span id="line-242">    }</span>
<span class="source-line-no">243</span><span id="line-243"></span>
<span class="source-line-no">244</span><span id="line-244">    /**</span>
<span class="source-line-no">245</span><span id="line-245">     * Gets an instance of PlotSquared.</span>
<span class="source-line-no">246</span><span id="line-246">     *</span>
<span class="source-line-no">247</span><span id="line-247">     * @return instance of PlotSquared</span>
<span class="source-line-no">248</span><span id="line-248">     */</span>
<span class="source-line-no">249</span><span id="line-249">    public static @NonNull PlotSquared get() {</span>
<span class="source-line-no">250</span><span id="line-250">        return PlotSquared.instance;</span>
<span class="source-line-no">251</span><span id="line-251">    }</span>
<span class="source-line-no">252</span><span id="line-252"></span>
<span class="source-line-no">253</span><span id="line-253">    /**</span>
<span class="source-line-no">254</span><span id="line-254">     * Get the platform specific implementation of PlotSquared</span>
<span class="source-line-no">255</span><span id="line-255">     *</span>
<span class="source-line-no">256</span><span id="line-256">     * @return Platform implementation</span>
<span class="source-line-no">257</span><span id="line-257">     */</span>
<span class="source-line-no">258</span><span id="line-258">    public static @NonNull PlotPlatform&lt;?&gt; platform() {</span>
<span class="source-line-no">259</span><span id="line-259">        if (instance != null &amp;&amp; instance.platform != null) {</span>
<span class="source-line-no">260</span><span id="line-260">            return instance.platform;</span>
<span class="source-line-no">261</span><span id="line-261">        }</span>
<span class="source-line-no">262</span><span id="line-262">        throw new IllegalStateException("Plot platform implementation is missing");</span>
<span class="source-line-no">263</span><span id="line-263">    }</span>
<span class="source-line-no">264</span><span id="line-264"></span>
<span class="source-line-no">265</span><span id="line-265">    public void loadCaptionMap() throws Exception {</span>
<span class="source-line-no">266</span><span id="line-266">        this.platform.copyCaptionMaps();</span>
<span class="source-line-no">267</span><span id="line-267">        // Setup localization</span>
<span class="source-line-no">268</span><span id="line-268">        CaptionMap captionMap;</span>
<span class="source-line-no">269</span><span id="line-269">        if (Settings.Enabled_Components.PER_USER_LOCALE) {</span>
<span class="source-line-no">270</span><span id="line-270">            captionMap = this.captionLoader.loadAll(this.platform.getDirectory().toPath().resolve("lang"));</span>
<span class="source-line-no">271</span><span id="line-271">        } else {</span>
<span class="source-line-no">272</span><span id="line-272">            String fileName = "messages_" + Settings.Enabled_Components.DEFAULT_LOCALE + ".json";</span>
<span class="source-line-no">273</span><span id="line-273">            captionMap = this.captionLoader.loadOrCreateSingle(this.platform.getDirectory().toPath().resolve("lang").resolve(fileName));</span>
<span class="source-line-no">274</span><span id="line-274">        }</span>
<span class="source-line-no">275</span><span id="line-275">        this.captionMaps.put(TranslatableCaption.DEFAULT_NAMESPACE, captionMap);</span>
<span class="source-line-no">276</span><span id="line-276">        LOGGER.info(</span>
<span class="source-line-no">277</span><span id="line-277">                "Loaded caption map for namespace 'plotsquared': {}",</span>
<span class="source-line-no">278</span><span id="line-278">                this.captionMaps.get(TranslatableCaption.DEFAULT_NAMESPACE).getClass().getCanonicalName()</span>
<span class="source-line-no">279</span><span id="line-279">        );</span>
<span class="source-line-no">280</span><span id="line-280">    }</span>
<span class="source-line-no">281</span><span id="line-281"></span>
<span class="source-line-no">282</span><span id="line-282">    /**</span>
<span class="source-line-no">283</span><span id="line-283">     * Get the platform specific {@link PlotAreaManager} instance</span>
<span class="source-line-no">284</span><span id="line-284">     *</span>
<span class="source-line-no">285</span><span id="line-285">     * @return Plot area manager</span>
<span class="source-line-no">286</span><span id="line-286">     */</span>
<span class="source-line-no">287</span><span id="line-287">    public @NonNull PlotAreaManager getPlotAreaManager() {</span>
<span class="source-line-no">288</span><span id="line-288">        return this.platform.plotAreaManager();</span>
<span class="source-line-no">289</span><span id="line-289">    }</span>
<span class="source-line-no">290</span><span id="line-290"></span>
<span class="source-line-no">291</span><span id="line-291">    public void startExpiryTasks() {</span>
<span class="source-line-no">292</span><span id="line-292">        if (Settings.Enabled_Components.PLOT_EXPIRY) {</span>
<span class="source-line-no">293</span><span id="line-293">            ExpireManager expireManager = PlotSquared.platform().expireManager();</span>
<span class="source-line-no">294</span><span id="line-294">            expireManager.runAutomatedTask();</span>
<span class="source-line-no">295</span><span id="line-295">            for (Settings.Auto_Clear settings : Settings.AUTO_CLEAR.getInstances()) {</span>
<span class="source-line-no">296</span><span id="line-296">                ExpiryTask task = new ExpiryTask(settings, this.getPlotAreaManager());</span>
<span class="source-line-no">297</span><span id="line-297">                expireManager.addTask(task);</span>
<span class="source-line-no">298</span><span id="line-298">            }</span>
<span class="source-line-no">299</span><span id="line-299">        }</span>
<span class="source-line-no">300</span><span id="line-300">    }</span>
<span class="source-line-no">301</span><span id="line-301"></span>
<span class="source-line-no">302</span><span id="line-302">    public boolean isMainThread(final @NonNull Thread thread) {</span>
<span class="source-line-no">303</span><span id="line-303">        return this.thread == thread;</span>
<span class="source-line-no">304</span><span id="line-304">    }</span>
<span class="source-line-no">305</span><span id="line-305"></span>
<span class="source-line-no">306</span><span id="line-306">    /**</span>
<span class="source-line-no">307</span><span id="line-307">     * Check if `version` is &amp;gt;= `version2`.</span>
<span class="source-line-no">308</span><span id="line-308">     *</span>
<span class="source-line-no">309</span><span id="line-309">     * @param version  First version</span>
<span class="source-line-no">310</span><span id="line-310">     * @param version2 Second version</span>
<span class="source-line-no">311</span><span id="line-311">     * @return {@code true} if `version` is &amp;gt;= `version2`</span>
<span class="source-line-no">312</span><span id="line-312">     */</span>
<span class="source-line-no">313</span><span id="line-313">    public boolean checkVersion(</span>
<span class="source-line-no">314</span><span id="line-314">            final int[] version,</span>
<span class="source-line-no">315</span><span id="line-315">            final int... version2</span>
<span class="source-line-no">316</span><span id="line-316">    ) {</span>
<span class="source-line-no">317</span><span id="line-317">        return version[0] &gt; version2[0] || version[0] == version2[0] &amp;&amp; version[1] &gt; version2[1]</span>
<span class="source-line-no">318</span><span id="line-318">                || version[0] == version2[0] &amp;&amp; version[1] == version2[1] &amp;&amp; version[2] &gt;= version2[2];</span>
<span class="source-line-no">319</span><span id="line-319">    }</span>
<span class="source-line-no">320</span><span id="line-320"></span>
<span class="source-line-no">321</span><span id="line-321">    /**</span>
<span class="source-line-no">322</span><span id="line-322">     * Gets the current PlotSquared version.</span>
<span class="source-line-no">323</span><span id="line-323">     *</span>
<span class="source-line-no">324</span><span id="line-324">     * @return current version in config or null</span>
<span class="source-line-no">325</span><span id="line-325">     */</span>
<span class="source-line-no">326</span><span id="line-326">    public @NonNull PlotVersion getVersion() {</span>
<span class="source-line-no">327</span><span id="line-327">        return this.version;</span>
<span class="source-line-no">328</span><span id="line-328">    }</span>
<span class="source-line-no">329</span><span id="line-329"></span>
<span class="source-line-no">330</span><span id="line-330">    /**</span>
<span class="source-line-no">331</span><span id="line-331">     * Gets the server platform this plugin is running on this is running on.</span>
<span class="source-line-no">332</span><span id="line-332">     *</span>
<span class="source-line-no">333</span><span id="line-333">     * &lt;p&gt;This will be either &lt;b&gt;Bukkit&lt;/b&gt; or &lt;b&gt;Sponge&lt;/b&gt;&lt;/p&gt;</span>
<span class="source-line-no">334</span><span id="line-334">     *</span>
<span class="source-line-no">335</span><span id="line-335">     * @return the server implementation</span>
<span class="source-line-no">336</span><span id="line-336">     */</span>
<span class="source-line-no">337</span><span id="line-337">    public @NonNull String getPlatform() {</span>
<span class="source-line-no">338</span><span id="line-338">        return Settings.PLATFORM;</span>
<span class="source-line-no">339</span><span id="line-339">    }</span>
<span class="source-line-no">340</span><span id="line-340"></span>
<span class="source-line-no">341</span><span id="line-341">    /**</span>
<span class="source-line-no">342</span><span id="line-342">     * Add a global reference to a plot world.</span>
<span class="source-line-no">343</span><span id="line-343">     * &lt;p&gt;</span>
<span class="source-line-no">344</span><span id="line-344">     * You can remove the reference by calling {@link #removePlotArea(PlotArea)}</span>
<span class="source-line-no">345</span><span id="line-345">     * &lt;/p&gt;</span>
<span class="source-line-no">346</span><span id="line-346">     *</span>
<span class="source-line-no">347</span><span id="line-347">     * @param plotArea the {@link PlotArea} to add.</span>
<span class="source-line-no">348</span><span id="line-348">     */</span>
<span class="source-line-no">349</span><span id="line-349">    @SuppressWarnings("unchecked")</span>
<span class="source-line-no">350</span><span id="line-350">    public void addPlotArea(final @NonNull PlotArea plotArea) {</span>
<span class="source-line-no">351</span><span id="line-351">        HashMap&lt;PlotId, Plot&gt; plots;</span>
<span class="source-line-no">352</span><span id="line-352">        if (plots_tmp == null || (plots = plots_tmp.remove(plotArea.toString())) == null) {</span>
<span class="source-line-no">353</span><span id="line-353">            if (plotArea.getType() == PlotAreaType.PARTIAL) {</span>
<span class="source-line-no">354</span><span id="line-354">                plots = this.plots_tmp != null ? this.plots_tmp.get(plotArea.getWorldName()) : null;</span>
<span class="source-line-no">355</span><span id="line-355">                if (plots != null) {</span>
<span class="source-line-no">356</span><span id="line-356">                    Iterator&lt;Entry&lt;PlotId, Plot&gt;&gt; iterator = plots.entrySet().iterator();</span>
<span class="source-line-no">357</span><span id="line-357">                    while (iterator.hasNext()) {</span>
<span class="source-line-no">358</span><span id="line-358">                        Entry&lt;PlotId, Plot&gt; next = iterator.next();</span>
<span class="source-line-no">359</span><span id="line-359">                        PlotId id = next.getKey();</span>
<span class="source-line-no">360</span><span id="line-360">                        if (plotArea.contains(id)) {</span>
<span class="source-line-no">361</span><span id="line-361">                            next.getValue().setArea(plotArea);</span>
<span class="source-line-no">362</span><span id="line-362">                            iterator.remove();</span>
<span class="source-line-no">363</span><span id="line-363">                        }</span>
<span class="source-line-no">364</span><span id="line-364">                    }</span>
<span class="source-line-no">365</span><span id="line-365">                }</span>
<span class="source-line-no">366</span><span id="line-366">            }</span>
<span class="source-line-no">367</span><span id="line-367">        } else {</span>
<span class="source-line-no">368</span><span id="line-368">            for (Plot entry : plots.values()) {</span>
<span class="source-line-no">369</span><span id="line-369">                entry.setArea(plotArea);</span>
<span class="source-line-no">370</span><span id="line-370">            }</span>
<span class="source-line-no">371</span><span id="line-371">        }</span>
<span class="source-line-no">372</span><span id="line-372">        Set&lt;PlotCluster&gt; clusters;</span>
<span class="source-line-no">373</span><span id="line-373">        if (clustersTmp == null || (clusters = clustersTmp.remove(plotArea.toString())) == null) {</span>
<span class="source-line-no">374</span><span id="line-374">            if (plotArea.getType() == PlotAreaType.PARTIAL) {</span>
<span class="source-line-no">375</span><span id="line-375">                clusters = this.clustersTmp != null ?</span>
<span class="source-line-no">376</span><span id="line-376">                        this.clustersTmp.get(plotArea.getWorldName()) :</span>
<span class="source-line-no">377</span><span id="line-377">                        null;</span>
<span class="source-line-no">378</span><span id="line-378">                if (clusters != null) {</span>
<span class="source-line-no">379</span><span id="line-379">                    Iterator&lt;PlotCluster&gt; iterator = clusters.iterator();</span>
<span class="source-line-no">380</span><span id="line-380">                    while (iterator.hasNext()) {</span>
<span class="source-line-no">381</span><span id="line-381">                        PlotCluster next = iterator.next();</span>
<span class="source-line-no">382</span><span id="line-382">                        if (next.intersects(plotArea.getMin(), plotArea.getMax())) {</span>
<span class="source-line-no">383</span><span id="line-383">                            next.setArea(plotArea);</span>
<span class="source-line-no">384</span><span id="line-384">                            iterator.remove();</span>
<span class="source-line-no">385</span><span id="line-385">                        }</span>
<span class="source-line-no">386</span><span id="line-386">                    }</span>
<span class="source-line-no">387</span><span id="line-387">                }</span>
<span class="source-line-no">388</span><span id="line-388">            }</span>
<span class="source-line-no">389</span><span id="line-389">        } else {</span>
<span class="source-line-no">390</span><span id="line-390">            for (PlotCluster cluster : clusters) {</span>
<span class="source-line-no">391</span><span id="line-391">                cluster.setArea(plotArea);</span>
<span class="source-line-no">392</span><span id="line-392">            }</span>
<span class="source-line-no">393</span><span id="line-393">        }</span>
<span class="source-line-no">394</span><span id="line-394">        getPlotAreaManager().addPlotArea(plotArea);</span>
<span class="source-line-no">395</span><span id="line-395">        plotArea.setupBorder();</span>
<span class="source-line-no">396</span><span id="line-396">        if (!Settings.Enabled_Components.PERSISTENT_ROAD_REGEN) {</span>
<span class="source-line-no">397</span><span id="line-397">            return;</span>
<span class="source-line-no">398</span><span id="line-398">        }</span>
<span class="source-line-no">399</span><span id="line-399">        File file = new File(</span>
<span class="source-line-no">400</span><span id="line-400">                this.platform.getDirectory() + File.separator + "persistent_regen_data_" + plotArea.getId()</span>
<span class="source-line-no">401</span><span id="line-401">                        + "_" + plotArea.getWorldName());</span>
<span class="source-line-no">402</span><span id="line-402">        if (!file.exists()) {</span>
<span class="source-line-no">403</span><span id="line-403">            return;</span>
<span class="source-line-no">404</span><span id="line-404">        }</span>
<span class="source-line-no">405</span><span id="line-405">        TaskManager.runTaskAsync(() -&gt; {</span>
<span class="source-line-no">406</span><span id="line-406">            try (ObjectInputStream ois = new ObjectInputStream(new FileInputStream(file))) {</span>
<span class="source-line-no">407</span><span id="line-407">                List&lt;Object&gt; list = (List&lt;Object&gt;) ois.readObject();</span>
<span class="source-line-no">408</span><span id="line-408">                ArrayList&lt;int[]&gt; regionInts = (ArrayList&lt;int[]&gt;) list.get(0);</span>
<span class="source-line-no">409</span><span id="line-409">                ArrayList&lt;int[]&gt; chunkInts = (ArrayList&lt;int[]&gt;) list.get(1);</span>
<span class="source-line-no">410</span><span id="line-410">                HashSet&lt;BlockVector2&gt; regions = new HashSet&lt;&gt;();</span>
<span class="source-line-no">411</span><span id="line-411">                Set&lt;BlockVector2&gt; chunks = new HashSet&lt;&gt;();</span>
<span class="source-line-no">412</span><span id="line-412">                regionInts.forEach(l -&gt; regions.add(BlockVector2.at(l[0], l[1])));</span>
<span class="source-line-no">413</span><span id="line-413">                chunkInts.forEach(l -&gt; chunks.add(BlockVector2.at(l[0], l[1])));</span>
<span class="source-line-no">414</span><span id="line-414">                int height = (int) list.get(2);</span>
<span class="source-line-no">415</span><span id="line-415">                LOGGER.info(</span>
<span class="source-line-no">416</span><span id="line-416">                        "Incomplete road regeneration found. Restarting in world {} with height {}",</span>
<span class="source-line-no">417</span><span id="line-417">                        plotArea.getWorldName(),</span>
<span class="source-line-no">418</span><span id="line-418">                        height</span>
<span class="source-line-no">419</span><span id="line-419">                );</span>
<span class="source-line-no">420</span><span id="line-420">                LOGGER.info("- Regions: {}", regions.size());</span>
<span class="source-line-no">421</span><span id="line-421">                LOGGER.info("- Chunks: {}", chunks.size());</span>
<span class="source-line-no">422</span><span id="line-422">                HybridUtils.UPDATE = true;</span>
<span class="source-line-no">423</span><span id="line-423">                PlotSquared.platform().hybridUtils().scheduleRoadUpdate(plotArea, regions, height, chunks);</span>
<span class="source-line-no">424</span><span id="line-424">            } catch (IOException | ClassNotFoundException e) {</span>
<span class="source-line-no">425</span><span id="line-425">                LOGGER.error("Error restarting road regeneration", e);</span>
<span class="source-line-no">426</span><span id="line-426">            } finally {</span>
<span class="source-line-no">427</span><span id="line-427">                if (!file.delete()) {</span>
<span class="source-line-no">428</span><span id="line-428">                    LOGGER.error("Error deleting persistent_regen_data_{}. Please delete this file manually", plotArea.getId());</span>
<span class="source-line-no">429</span><span id="line-429">                }</span>
<span class="source-line-no">430</span><span id="line-430">            }</span>
<span class="source-line-no">431</span><span id="line-431">        });</span>
<span class="source-line-no">432</span><span id="line-432">    }</span>
<span class="source-line-no">433</span><span id="line-433"></span>
<span class="source-line-no">434</span><span id="line-434">    /**</span>
<span class="source-line-no">435</span><span id="line-435">     * Remove a plot world reference.</span>
<span class="source-line-no">436</span><span id="line-436">     *</span>
<span class="source-line-no">437</span><span id="line-437">     * @param area the {@link PlotArea} to remove</span>
<span class="source-line-no">438</span><span id="line-438">     */</span>
<span class="source-line-no">439</span><span id="line-439">    public void removePlotArea(final @NonNull PlotArea area) {</span>
<span class="source-line-no">440</span><span id="line-440">        getPlotAreaManager().removePlotArea(area);</span>
<span class="source-line-no">441</span><span id="line-441">        setPlotsTmp(area);</span>
<span class="source-line-no">442</span><span id="line-442">    }</span>
<span class="source-line-no">443</span><span id="line-443"></span>
<span class="source-line-no">444</span><span id="line-444">    public void removePlotAreas(final @NonNull String world) {</span>
<span class="source-line-no">445</span><span id="line-445">        for (final PlotArea area : this.getPlotAreaManager().getPlotAreasSet(world)) {</span>
<span class="source-line-no">446</span><span id="line-446">            if (area.getWorldName().equals(world)) {</span>
<span class="source-line-no">447</span><span id="line-447">                removePlotArea(area);</span>
<span class="source-line-no">448</span><span id="line-448">            }</span>
<span class="source-line-no">449</span><span id="line-449">        }</span>
<span class="source-line-no">450</span><span id="line-450">    }</span>
<span class="source-line-no">451</span><span id="line-451"></span>
<span class="source-line-no">452</span><span id="line-452">    private void setPlotsTmp(final @NonNull PlotArea area) {</span>
<span class="source-line-no">453</span><span id="line-453">        if (this.plots_tmp == null) {</span>
<span class="source-line-no">454</span><span id="line-454">            this.plots_tmp = new HashMap&lt;&gt;();</span>
<span class="source-line-no">455</span><span id="line-455">        }</span>
<span class="source-line-no">456</span><span id="line-456">        HashMap&lt;PlotId, Plot&gt; map =</span>
<span class="source-line-no">457</span><span id="line-457">                this.plots_tmp.computeIfAbsent(area.toString(), k -&gt; new HashMap&lt;&gt;());</span>
<span class="source-line-no">458</span><span id="line-458">        for (Plot plot : area.getPlots()) {</span>
<span class="source-line-no">459</span><span id="line-459">            map.put(plot.getId(), plot);</span>
<span class="source-line-no">460</span><span id="line-460">        }</span>
<span class="source-line-no">461</span><span id="line-461">        if (this.clustersTmp == null) {</span>
<span class="source-line-no">462</span><span id="line-462">            this.clustersTmp = new HashMap&lt;&gt;();</span>
<span class="source-line-no">463</span><span id="line-463">        }</span>
<span class="source-line-no">464</span><span id="line-464">        this.clustersTmp.put(area.toString(), area.getClusters());</span>
<span class="source-line-no">465</span><span id="line-465">    }</span>
<span class="source-line-no">466</span><span id="line-466"></span>
<span class="source-line-no">467</span><span id="line-467">    public Set&lt;PlotCluster&gt; getClusters(final @NonNull String world) {</span>
<span class="source-line-no">468</span><span id="line-468">        final Set&lt;PlotCluster&gt; set = new HashSet&lt;&gt;();</span>
<span class="source-line-no">469</span><span id="line-469">        for (final PlotArea area : this.getPlotAreaManager().getPlotAreasSet(world)) {</span>
<span class="source-line-no">470</span><span id="line-470">            set.addAll(area.getClusters());</span>
<span class="source-line-no">471</span><span id="line-471">        }</span>
<span class="source-line-no">472</span><span id="line-472">        return Collections.unmodifiableSet(set);</span>
<span class="source-line-no">473</span><span id="line-473"></span>
<span class="source-line-no">474</span><span id="line-474">    }</span>
<span class="source-line-no">475</span><span id="line-475"></span>
<span class="source-line-no">476</span><span id="line-476">    public List&lt;Plot&gt; sortPlotsByTemp(Collection&lt;Plot&gt; plots) {</span>
<span class="source-line-no">477</span><span id="line-477">        int max = 0;</span>
<span class="source-line-no">478</span><span id="line-478">        int overflowCount = 0;</span>
<span class="source-line-no">479</span><span id="line-479">        for (Plot plot : plots) {</span>
<span class="source-line-no">480</span><span id="line-480">            if (plot.temp &gt; 0) {</span>
<span class="source-line-no">481</span><span id="line-481">                if (plot.temp &gt; max) {</span>
<span class="source-line-no">482</span><span id="line-482">                    max = plot.temp;</span>
<span class="source-line-no">483</span><span id="line-483">                }</span>
<span class="source-line-no">484</span><span id="line-484">            } else {</span>
<span class="source-line-no">485</span><span id="line-485">                overflowCount++;</span>
<span class="source-line-no">486</span><span id="line-486">            }</span>
<span class="source-line-no">487</span><span id="line-487">        }</span>
<span class="source-line-no">488</span><span id="line-488">        Plot[] array = new Plot[max + 1];</span>
<span class="source-line-no">489</span><span id="line-489">        List&lt;Plot&gt; overflow = new ArrayList&lt;&gt;(overflowCount);</span>
<span class="source-line-no">490</span><span id="line-490">        for (Plot plot : plots) {</span>
<span class="source-line-no">491</span><span id="line-491">            if (plot.temp &lt;= 0) {</span>
<span class="source-line-no">492</span><span id="line-492">                overflow.add(plot);</span>
<span class="source-line-no">493</span><span id="line-493">            } else {</span>
<span class="source-line-no">494</span><span id="line-494">                array[plot.temp] = plot;</span>
<span class="source-line-no">495</span><span id="line-495">            }</span>
<span class="source-line-no">496</span><span id="line-496">        }</span>
<span class="source-line-no">497</span><span id="line-497">        ArrayList&lt;Plot&gt; result = new ArrayList&lt;&gt;(plots.size());</span>
<span class="source-line-no">498</span><span id="line-498">        for (Plot plot : array) {</span>
<span class="source-line-no">499</span><span id="line-499">            if (plot != null) {</span>
<span class="source-line-no">500</span><span id="line-500">                result.add(plot);</span>
<span class="source-line-no">501</span><span id="line-501">            }</span>
<span class="source-line-no">502</span><span id="line-502">        }</span>
<span class="source-line-no">503</span><span id="line-503">        overflow.sort(Comparator.comparingInt(Plot::hashCode));</span>
<span class="source-line-no">504</span><span id="line-504">        result.addAll(overflow);</span>
<span class="source-line-no">505</span><span id="line-505">        return result;</span>
<span class="source-line-no">506</span><span id="line-506">    }</span>
<span class="source-line-no">507</span><span id="line-507"></span>
<span class="source-line-no">508</span><span id="line-508">    /**</span>
<span class="source-line-no">509</span><span id="line-509">     * Sort plots by hashcode.</span>
<span class="source-line-no">510</span><span id="line-510">     *</span>
<span class="source-line-no">511</span><span id="line-511">     * @param plots the collection of plots to sort</span>
<span class="source-line-no">512</span><span id="line-512">     * @return the sorted collection</span>
<span class="source-line-no">513</span><span id="line-513">     */</span>
<span class="source-line-no">514</span><span id="line-514">    private ArrayList&lt;Plot&gt; sortPlotsByHash(Collection&lt;Plot&gt; plots) {</span>
<span class="source-line-no">515</span><span id="line-515">        int hardmax = 256000;</span>
<span class="source-line-no">516</span><span id="line-516">        int max = 0;</span>
<span class="source-line-no">517</span><span id="line-517">        int overflowSize = 0;</span>
<span class="source-line-no">518</span><span id="line-518">        for (Plot plot : plots) {</span>
<span class="source-line-no">519</span><span id="line-519">            int hash = MathMan.getPositiveId(plot.hashCode());</span>
<span class="source-line-no">520</span><span id="line-520">            if (hash &gt; max) {</span>
<span class="source-line-no">521</span><span id="line-521">                if (hash &gt;= hardmax) {</span>
<span class="source-line-no">522</span><span id="line-522">                    overflowSize++;</span>
<span class="source-line-no">523</span><span id="line-523">                } else {</span>
<span class="source-line-no">524</span><span id="line-524">                    max = hash;</span>
<span class="source-line-no">525</span><span id="line-525">                }</span>
<span class="source-line-no">526</span><span id="line-526">            }</span>
<span class="source-line-no">527</span><span id="line-527">        }</span>
<span class="source-line-no">528</span><span id="line-528">        hardmax = Math.min(hardmax, max);</span>
<span class="source-line-no">529</span><span id="line-529">        Plot[] cache = new Plot[hardmax + 1];</span>
<span class="source-line-no">530</span><span id="line-530">        List&lt;Plot&gt; overflow = new ArrayList&lt;&gt;(overflowSize);</span>
<span class="source-line-no">531</span><span id="line-531">        ArrayList&lt;Plot&gt; extra = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">532</span><span id="line-532">        for (Plot plot : plots) {</span>
<span class="source-line-no">533</span><span id="line-533">            int hash = MathMan.getPositiveId(plot.hashCode());</span>
<span class="source-line-no">534</span><span id="line-534">            if (hash &lt; hardmax) {</span>
<span class="source-line-no">535</span><span id="line-535">                if (hash &gt;= 0) {</span>
<span class="source-line-no">536</span><span id="line-536">                    cache[hash] = plot;</span>
<span class="source-line-no">537</span><span id="line-537">                } else {</span>
<span class="source-line-no">538</span><span id="line-538">                    extra.add(plot);</span>
<span class="source-line-no">539</span><span id="line-539">                }</span>
<span class="source-line-no">540</span><span id="line-540">            } else if (Math.abs(plot.getId().getX()) &gt; 15446 || Math.abs(plot.getId().getY()) &gt; 15446) {</span>
<span class="source-line-no">541</span><span id="line-541">                extra.add(plot);</span>
<span class="source-line-no">542</span><span id="line-542">            } else {</span>
<span class="source-line-no">543</span><span id="line-543">                overflow.add(plot);</span>
<span class="source-line-no">544</span><span id="line-544">            }</span>
<span class="source-line-no">545</span><span id="line-545">        }</span>
<span class="source-line-no">546</span><span id="line-546">        Plot[] overflowArray = overflow.toArray(new Plot[0]);</span>
<span class="source-line-no">547</span><span id="line-547">        sortPlotsByHash(overflowArray);</span>
<span class="source-line-no">548</span><span id="line-548">        ArrayList&lt;Plot&gt; result = new ArrayList&lt;&gt;(cache.length + overflowArray.length);</span>
<span class="source-line-no">549</span><span id="line-549">        for (Plot plot : cache) {</span>
<span class="source-line-no">550</span><span id="line-550">            if (plot != null) {</span>
<span class="source-line-no">551</span><span id="line-551">                result.add(plot);</span>
<span class="source-line-no">552</span><span id="line-552">            }</span>
<span class="source-line-no">553</span><span id="line-553">        }</span>
<span class="source-line-no">554</span><span id="line-554">        Collections.addAll(result, overflowArray);</span>
<span class="source-line-no">555</span><span id="line-555">        result.addAll(extra);</span>
<span class="source-line-no">556</span><span id="line-556">        return result;</span>
<span class="source-line-no">557</span><span id="line-557">    }</span>
<span class="source-line-no">558</span><span id="line-558"></span>
<span class="source-line-no">559</span><span id="line-559">    /**</span>
<span class="source-line-no">560</span><span id="line-560">     * Unchecked, use {@link #sortPlots(Collection, SortType, PlotArea)} instead which will in turn call this.</span>
<span class="source-line-no">561</span><span id="line-561">     *</span>
<span class="source-line-no">562</span><span id="line-562">     * @param input an array of plots to sort</span>
<span class="source-line-no">563</span><span id="line-563">     */</span>
<span class="source-line-no">564</span><span id="line-564">    @SuppressWarnings("unchecked")</span>
<span class="source-line-no">565</span><span id="line-565">    private void sortPlotsByHash(final @NonNull Plot @NonNull [] input) {</span>
<span class="source-line-no">566</span><span id="line-566">        List&lt;Plot&gt;[] bucket = new ArrayList[32];</span>
<span class="source-line-no">567</span><span id="line-567">        Arrays.fill(bucket, new ArrayList&lt;&gt;());</span>
<span class="source-line-no">568</span><span id="line-568">        boolean maxLength = false;</span>
<span class="source-line-no">569</span><span id="line-569">        int placement = 1;</span>
<span class="source-line-no">570</span><span id="line-570">        while (!maxLength) {</span>
<span class="source-line-no">571</span><span id="line-571">            maxLength = true;</span>
<span class="source-line-no">572</span><span id="line-572">            for (Plot plot : input) {</span>
<span class="source-line-no">573</span><span id="line-573">                int tmp = MathMan.getPositiveId(plot.hashCode()) / placement;</span>
<span class="source-line-no">574</span><span id="line-574">                bucket[tmp &amp; 31].add(plot);</span>
<span class="source-line-no">575</span><span id="line-575">                if (maxLength &amp;&amp; tmp &gt; 0) {</span>
<span class="source-line-no">576</span><span id="line-576">                    maxLength = false;</span>
<span class="source-line-no">577</span><span id="line-577">                }</span>
<span class="source-line-no">578</span><span id="line-578">            }</span>
<span class="source-line-no">579</span><span id="line-579">            int a = 0;</span>
<span class="source-line-no">580</span><span id="line-580">            for (int i = 0; i &lt; 32; i++) {</span>
<span class="source-line-no">581</span><span id="line-581">                for (Plot plot : bucket[i]) {</span>
<span class="source-line-no">582</span><span id="line-582">                    input[a++] = plot;</span>
<span class="source-line-no">583</span><span id="line-583">                }</span>
<span class="source-line-no">584</span><span id="line-584">                bucket[i].clear();</span>
<span class="source-line-no">585</span><span id="line-585">            }</span>
<span class="source-line-no">586</span><span id="line-586">            placement *= 32;</span>
<span class="source-line-no">587</span><span id="line-587">        }</span>
<span class="source-line-no">588</span><span id="line-588">    }</span>
<span class="source-line-no">589</span><span id="line-589"></span>
<span class="source-line-no">590</span><span id="line-590">    private @NonNull List&lt;Plot&gt; sortPlotsByTimestamp(final @NonNull Collection&lt;Plot&gt; plots) {</span>
<span class="source-line-no">591</span><span id="line-591">        int hardMax = 256000;</span>
<span class="source-line-no">592</span><span id="line-592">        int max = 0;</span>
<span class="source-line-no">593</span><span id="line-593">        int overflowSize = 0;</span>
<span class="source-line-no">594</span><span id="line-594">        for (final Plot plot : plots) {</span>
<span class="source-line-no">595</span><span id="line-595">            int hash = MathMan.getPositiveId(plot.hashCode());</span>
<span class="source-line-no">596</span><span id="line-596">            if (hash &gt; max) {</span>
<span class="source-line-no">597</span><span id="line-597">                if (hash &gt;= hardMax) {</span>
<span class="source-line-no">598</span><span id="line-598">                    overflowSize++;</span>
<span class="source-line-no">599</span><span id="line-599">                } else {</span>
<span class="source-line-no">600</span><span id="line-600">                    max = hash;</span>
<span class="source-line-no">601</span><span id="line-601">                }</span>
<span class="source-line-no">602</span><span id="line-602">            }</span>
<span class="source-line-no">603</span><span id="line-603">        }</span>
<span class="source-line-no">604</span><span id="line-604">        hardMax = Math.min(hardMax, max);</span>
<span class="source-line-no">605</span><span id="line-605">        Plot[] cache = new Plot[hardMax + 1];</span>
<span class="source-line-no">606</span><span id="line-606">        List&lt;Plot&gt; overflow = new ArrayList&lt;&gt;(overflowSize);</span>
<span class="source-line-no">607</span><span id="line-607">        ArrayList&lt;Plot&gt; extra = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">608</span><span id="line-608">        for (Plot plot : plots) {</span>
<span class="source-line-no">609</span><span id="line-609">            int hash = MathMan.getPositiveId(plot.hashCode());</span>
<span class="source-line-no">610</span><span id="line-610">            if (hash &lt; hardMax) {</span>
<span class="source-line-no">611</span><span id="line-611">                if (hash &gt;= 0) {</span>
<span class="source-line-no">612</span><span id="line-612">                    cache[hash] = plot;</span>
<span class="source-line-no">613</span><span id="line-613">                } else {</span>
<span class="source-line-no">614</span><span id="line-614">                    extra.add(plot);</span>
<span class="source-line-no">615</span><span id="line-615">                }</span>
<span class="source-line-no">616</span><span id="line-616">            } else if (Math.abs(plot.getId().getX()) &gt; 15446 || Math.abs(plot.getId().getY()) &gt; 15446) {</span>
<span class="source-line-no">617</span><span id="line-617">                extra.add(plot);</span>
<span class="source-line-no">618</span><span id="line-618">            } else {</span>
<span class="source-line-no">619</span><span id="line-619">                overflow.add(plot);</span>
<span class="source-line-no">620</span><span id="line-620">            }</span>
<span class="source-line-no">621</span><span id="line-621">        }</span>
<span class="source-line-no">622</span><span id="line-622">        Plot[] overflowArray = overflow.toArray(new Plot[0]);</span>
<span class="source-line-no">623</span><span id="line-623">        sortPlotsByHash(overflowArray);</span>
<span class="source-line-no">624</span><span id="line-624">        ArrayList&lt;Plot&gt; result = new ArrayList&lt;&gt;(cache.length + overflowArray.length);</span>
<span class="source-line-no">625</span><span id="line-625">        for (Plot plot : cache) {</span>
<span class="source-line-no">626</span><span id="line-626">            if (plot != null) {</span>
<span class="source-line-no">627</span><span id="line-627">                result.add(plot);</span>
<span class="source-line-no">628</span><span id="line-628">            }</span>
<span class="source-line-no">629</span><span id="line-629">        }</span>
<span class="source-line-no">630</span><span id="line-630">        Collections.addAll(result, overflowArray);</span>
<span class="source-line-no">631</span><span id="line-631">        result.addAll(extra);</span>
<span class="source-line-no">632</span><span id="line-632">        return result;</span>
<span class="source-line-no">633</span><span id="line-633">    }</span>
<span class="source-line-no">634</span><span id="line-634"></span>
<span class="source-line-no">635</span><span id="line-635">    /**</span>
<span class="source-line-no">636</span><span id="line-636">     * Sort plots by creation timestamp.</span>
<span class="source-line-no">637</span><span id="line-637">     *</span>
<span class="source-line-no">638</span><span id="line-638">     * @param input Plots to sort</span>
<span class="source-line-no">639</span><span id="line-639">     * @return Sorted list</span>
<span class="source-line-no">640</span><span id="line-640">     */</span>
<span class="source-line-no">641</span><span id="line-641">    private @NonNull List&lt;Plot&gt; sortPlotsByModified(final @NonNull Collection&lt;Plot&gt; input) {</span>
<span class="source-line-no">642</span><span id="line-642">        List&lt;Plot&gt; list;</span>
<span class="source-line-no">643</span><span id="line-643">        if (input instanceof List) {</span>
<span class="source-line-no">644</span><span id="line-644">            list = (List&lt;Plot&gt;) input;</span>
<span class="source-line-no">645</span><span id="line-645">        } else {</span>
<span class="source-line-no">646</span><span id="line-646">            list = new ArrayList&lt;&gt;(input);</span>
<span class="source-line-no">647</span><span id="line-647">        }</span>
<span class="source-line-no">648</span><span id="line-648">        ExpireManager expireManager = PlotSquared.platform().expireManager();</span>
<span class="source-line-no">649</span><span id="line-649">        list.sort(Comparator.comparingLong(a -&gt; expireManager.getTimestamp(a.getOwnerAbs())));</span>
<span class="source-line-no">650</span><span id="line-650">        return list;</span>
<span class="source-line-no">651</span><span id="line-651">    }</span>
<span class="source-line-no">652</span><span id="line-652"></span>
<span class="source-line-no">653</span><span id="line-653">    /**</span>
<span class="source-line-no">654</span><span id="line-654">     * Sort a collection of plots by world (with a priority world), then</span>
<span class="source-line-no">655</span><span id="line-655">     * by hashcode.</span>
<span class="source-line-no">656</span><span id="line-656">     *</span>
<span class="source-line-no">657</span><span id="line-657">     * @param plots        the plots to sort</span>
<span class="source-line-no">658</span><span id="line-658">     * @param type         The sorting method to use for each world (timestamp, or hash)</span>
<span class="source-line-no">659</span><span id="line-659">     * @param priorityArea Use null, "world", or "gibberish" if you</span>
<span class="source-line-no">660</span><span id="line-660">     *                     want default world order</span>
<span class="source-line-no">661</span><span id="line-661">     * @return ArrayList of plot</span>
<span class="source-line-no">662</span><span id="line-662">     */</span>
<span class="source-line-no">663</span><span id="line-663">    public @NonNull List&lt;Plot&gt; sortPlots(</span>
<span class="source-line-no">664</span><span id="line-664">            final @NonNull Collection&lt;Plot&gt; plots,</span>
<span class="source-line-no">665</span><span id="line-665">            final @NonNull SortType type,</span>
<span class="source-line-no">666</span><span id="line-666">            final @Nullable PlotArea priorityArea</span>
<span class="source-line-no">667</span><span id="line-667">    ) {</span>
<span class="source-line-no">668</span><span id="line-668">        // group by world</span>
<span class="source-line-no">669</span><span id="line-669">        // sort each</span>
<span class="source-line-no">670</span><span id="line-670">        HashMap&lt;PlotArea, Collection&lt;Plot&gt;&gt; map = new HashMap&lt;&gt;();</span>
<span class="source-line-no">671</span><span id="line-671">        int totalSize = Arrays.stream(this.getPlotAreaManager().getAllPlotAreas()).mapToInt(PlotArea::getPlotCount).sum();</span>
<span class="source-line-no">672</span><span id="line-672">        if (plots.size() == totalSize) {</span>
<span class="source-line-no">673</span><span id="line-673">            for (PlotArea area : getPlotAreaManager().getAllPlotAreas()) {</span>
<span class="source-line-no">674</span><span id="line-674">                map.put(area, area.getPlots());</span>
<span class="source-line-no">675</span><span id="line-675">            }</span>
<span class="source-line-no">676</span><span id="line-676">        } else {</span>
<span class="source-line-no">677</span><span id="line-677">            for (PlotArea area : getPlotAreaManager().getAllPlotAreas()) {</span>
<span class="source-line-no">678</span><span id="line-678">                map.put(area, new ArrayList&lt;&gt;(0));</span>
<span class="source-line-no">679</span><span id="line-679">            }</span>
<span class="source-line-no">680</span><span id="line-680">            Collection&lt;Plot&gt; lastList = null;</span>
<span class="source-line-no">681</span><span id="line-681">            PlotArea lastWorld = null;</span>
<span class="source-line-no">682</span><span id="line-682">            for (Plot plot : plots) {</span>
<span class="source-line-no">683</span><span id="line-683">                if (lastWorld == plot.getArea()) {</span>
<span class="source-line-no">684</span><span id="line-684">                    lastList.add(plot);</span>
<span class="source-line-no">685</span><span id="line-685">                } else {</span>
<span class="source-line-no">686</span><span id="line-686">                    lastWorld = plot.getArea();</span>
<span class="source-line-no">687</span><span id="line-687">                    lastList = map.get(lastWorld);</span>
<span class="source-line-no">688</span><span id="line-688">                    lastList.add(plot);</span>
<span class="source-line-no">689</span><span id="line-689">                }</span>
<span class="source-line-no">690</span><span id="line-690">            }</span>
<span class="source-line-no">691</span><span id="line-691">        }</span>
<span class="source-line-no">692</span><span id="line-692">        List&lt;PlotArea&gt; areas = Arrays.asList(getPlotAreaManager().getAllPlotAreas());</span>
<span class="source-line-no">693</span><span id="line-693">        areas.sort((a, b) -&gt; {</span>
<span class="source-line-no">694</span><span id="line-694">            if (priorityArea != null) {</span>
<span class="source-line-no">695</span><span id="line-695">                if (a.equals(priorityArea)) {</span>
<span class="source-line-no">696</span><span id="line-696">                    return -1;</span>
<span class="source-line-no">697</span><span id="line-697">                } else if (b.equals(priorityArea)) {</span>
<span class="source-line-no">698</span><span id="line-698">                    return 1;</span>
<span class="source-line-no">699</span><span id="line-699">                }</span>
<span class="source-line-no">700</span><span id="line-700">            }</span>
<span class="source-line-no">701</span><span id="line-701">            return a.hashCode() - b.hashCode();</span>
<span class="source-line-no">702</span><span id="line-702">        });</span>
<span class="source-line-no">703</span><span id="line-703">        ArrayList&lt;Plot&gt; toReturn = new ArrayList&lt;&gt;(plots.size());</span>
<span class="source-line-no">704</span><span id="line-704">        for (PlotArea area : areas) {</span>
<span class="source-line-no">705</span><span id="line-705">            switch (type) {</span>
<span class="source-line-no">706</span><span id="line-706">                case CREATION_DATE -&gt; toReturn.addAll(sortPlotsByTemp(map.get(area)));</span>
<span class="source-line-no">707</span><span id="line-707">                case CREATION_DATE_TIMESTAMP -&gt; toReturn.addAll(sortPlotsByTimestamp(map.get(area)));</span>
<span class="source-line-no">708</span><span id="line-708">                case DISTANCE_FROM_ORIGIN -&gt; toReturn.addAll(sortPlotsByHash(map.get(area)));</span>
<span class="source-line-no">709</span><span id="line-709">                case LAST_MODIFIED -&gt; toReturn.addAll(sortPlotsByModified(map.get(area)));</span>
<span class="source-line-no">710</span><span id="line-710">                default -&gt; {</span>
<span class="source-line-no">711</span><span id="line-711">                }</span>
<span class="source-line-no">712</span><span id="line-712">            }</span>
<span class="source-line-no">713</span><span id="line-713">        }</span>
<span class="source-line-no">714</span><span id="line-714">        return toReturn;</span>
<span class="source-line-no">715</span><span id="line-715">    }</span>
<span class="source-line-no">716</span><span id="line-716"></span>
<span class="source-line-no">717</span><span id="line-717">    public void setPlots(final @NonNull Map&lt;String, HashMap&lt;PlotId, Plot&gt;&gt; plots) {</span>
<span class="source-line-no">718</span><span id="line-718">        if (this.plots_tmp == null) {</span>
<span class="source-line-no">719</span><span id="line-719">            this.plots_tmp = new HashMap&lt;&gt;();</span>
<span class="source-line-no">720</span><span id="line-720">        }</span>
<span class="source-line-no">721</span><span id="line-721">        for (final Entry&lt;String, HashMap&lt;PlotId, Plot&gt;&gt; entry : plots.entrySet()) {</span>
<span class="source-line-no">722</span><span id="line-722">            final String world = entry.getKey();</span>
<span class="source-line-no">723</span><span id="line-723">            final PlotArea plotArea = this.getPlotAreaManager().getPlotArea(world, null);</span>
<span class="source-line-no">724</span><span id="line-724">            if (plotArea == null) {</span>
<span class="source-line-no">725</span><span id="line-725">                Map&lt;PlotId, Plot&gt; map = this.plots_tmp.computeIfAbsent(world, k -&gt; new HashMap&lt;&gt;());</span>
<span class="source-line-no">726</span><span id="line-726">                map.putAll(entry.getValue());</span>
<span class="source-line-no">727</span><span id="line-727">            } else {</span>
<span class="source-line-no">728</span><span id="line-728">                for (Plot plot : entry.getValue().values()) {</span>
<span class="source-line-no">729</span><span id="line-729">                    plot.setArea(plotArea);</span>
<span class="source-line-no">730</span><span id="line-730">                    plotArea.addPlot(plot);</span>
<span class="source-line-no">731</span><span id="line-731">                }</span>
<span class="source-line-no">732</span><span id="line-732">            }</span>
<span class="source-line-no">733</span><span id="line-733">        }</span>
<span class="source-line-no">734</span><span id="line-734">    }</span>
<span class="source-line-no">735</span><span id="line-735"></span>
<span class="source-line-no">736</span><span id="line-736">    /**</span>
<span class="source-line-no">737</span><span id="line-737">     * Unregisters a plot from local memory without calling the database.</span>
<span class="source-line-no">738</span><span id="line-738">     *</span>
<span class="source-line-no">739</span><span id="line-739">     * @param plot      the plot to remove</span>
<span class="source-line-no">740</span><span id="line-740">     * @param callEvent If to call an event about the plot being removed</span>
<span class="source-line-no">741</span><span id="line-741">     * @return {@code true} if plot existed | {@code false} if it didn't</span>
<span class="source-line-no">742</span><span id="line-742">     */</span>
<span class="source-line-no">743</span><span id="line-743">    public boolean removePlot(</span>
<span class="source-line-no">744</span><span id="line-744">            final @NonNull Plot plot,</span>
<span class="source-line-no">745</span><span id="line-745">            final boolean callEvent</span>
<span class="source-line-no">746</span><span id="line-746">    ) {</span>
<span class="source-line-no">747</span><span id="line-747">        if (plot == null) {</span>
<span class="source-line-no">748</span><span id="line-748">            return false;</span>
<span class="source-line-no">749</span><span id="line-749">        }</span>
<span class="source-line-no">750</span><span id="line-750">        if (callEvent) {</span>
<span class="source-line-no">751</span><span id="line-751">            eventDispatcher.callDelete(plot);</span>
<span class="source-line-no">752</span><span id="line-752">        }</span>
<span class="source-line-no">753</span><span id="line-753">        if (plot.getArea().removePlot(plot.getId())) {</span>
<span class="source-line-no">754</span><span id="line-754">            PlotId last = (PlotId) plot.getArea().getMeta("lastPlot");</span>
<span class="source-line-no">755</span><span id="line-755">            int last_max = Math.max(Math.abs(last.getX()), Math.abs(last.getY()));</span>
<span class="source-line-no">756</span><span id="line-756">            int this_max = Math.max(Math.abs(plot.getId().getX()), Math.abs(plot.getId().getY()));</span>
<span class="source-line-no">757</span><span id="line-757">            if (this_max &lt; last_max) {</span>
<span class="source-line-no">758</span><span id="line-758">                plot.getArea().setMeta("lastPlot", plot.getId());</span>
<span class="source-line-no">759</span><span id="line-759">            }</span>
<span class="source-line-no">760</span><span id="line-760">            if (callEvent) {</span>
<span class="source-line-no">761</span><span id="line-761">                eventDispatcher.callPostDelete(plot);</span>
<span class="source-line-no">762</span><span id="line-762">            }</span>
<span class="source-line-no">763</span><span id="line-763">            return true;</span>
<span class="source-line-no">764</span><span id="line-764">        }</span>
<span class="source-line-no">765</span><span id="line-765">        return false;</span>
<span class="source-line-no">766</span><span id="line-766">    }</span>
<span class="source-line-no">767</span><span id="line-767"></span>
<span class="source-line-no">768</span><span id="line-768">    /**</span>
<span class="source-line-no">769</span><span id="line-769">     * This method is called by the PlotGenerator class normally.</span>
<span class="source-line-no">770</span><span id="line-770">     * &lt;ul&gt;</span>
<span class="source-line-no">771</span><span id="line-771">     * &lt;li&gt;Initializes the PlotArea and PlotManager classes</span>
<span class="source-line-no">772</span><span id="line-772">     * &lt;li&gt;Registers the PlotArea and PlotManager classes</span>
<span class="source-line-no">773</span><span id="line-773">     * &lt;li&gt;Loads (and/or generates) the PlotArea configuration</span>
<span class="source-line-no">774</span><span id="line-774">     * &lt;li&gt;Sets up the world border if configured</span>
<span class="source-line-no">775</span><span id="line-775">     * &lt;/ul&gt;</span>
<span class="source-line-no">776</span><span id="line-776">     *</span>
<span class="source-line-no">777</span><span id="line-777">     * &lt;p&gt;If loading an augmented plot world:</span>
<span class="source-line-no">778</span><span id="line-778">     * &lt;ul&gt;</span>
<span class="source-line-no">779</span><span id="line-779">     * &lt;li&gt;Creates the AugmentedPopulator classes</span>
<span class="source-line-no">780</span><span id="line-780">     * &lt;li&gt;Injects the AugmentedPopulator classes if required</span>
<span class="source-line-no">781</span><span id="line-781">     * &lt;/ul&gt;</span>
<span class="source-line-no">782</span><span id="line-782">     *</span>
<span class="source-line-no">783</span><span id="line-783">     * @param world         the world to load</span>
<span class="source-line-no">784</span><span id="line-784">     * @param baseGenerator The generator for that world, or null</span>
<span class="source-line-no">785</span><span id="line-785">     */</span>
<span class="source-line-no">786</span><span id="line-786">    public void loadWorld(</span>
<span class="source-line-no">787</span><span id="line-787">            final @NonNull String world,</span>
<span class="source-line-no">788</span><span id="line-788">            final @Nullable GeneratorWrapper&lt;?&gt; baseGenerator</span>
<span class="source-line-no">789</span><span id="line-789">    ) {</span>
<span class="source-line-no">790</span><span id="line-790">        if (world.equals("CheckingPlotSquaredGenerator")) {</span>
<span class="source-line-no">791</span><span id="line-791">            return;</span>
<span class="source-line-no">792</span><span id="line-792">        }</span>
<span class="source-line-no">793</span><span id="line-793">        this.getPlotAreaManager().addWorld(world);</span>
<span class="source-line-no">794</span><span id="line-794">        Set&lt;String&gt; worlds;</span>
<span class="source-line-no">795</span><span id="line-795">        if (this.worldConfiguration.contains("worlds")) {</span>
<span class="source-line-no">796</span><span id="line-796">            worlds = this.worldConfiguration.getConfigurationSection("worlds").getKeys(false);</span>
<span class="source-line-no">797</span><span id="line-797">        } else {</span>
<span class="source-line-no">798</span><span id="line-798">            worlds = new HashSet&lt;&gt;();</span>
<span class="source-line-no">799</span><span id="line-799">        }</span>
<span class="source-line-no">800</span><span id="line-800">        String path = "worlds." + world;</span>
<span class="source-line-no">801</span><span id="line-801">        ConfigurationSection worldSection = this.worldConfiguration.getConfigurationSection(path);</span>
<span class="source-line-no">802</span><span id="line-802">        PlotAreaType type;</span>
<span class="source-line-no">803</span><span id="line-803">        if (worldSection != null) {</span>
<span class="source-line-no">804</span><span id="line-804">            type = ConfigurationUtil.getType(worldSection);</span>
<span class="source-line-no">805</span><span id="line-805">        } else {</span>
<span class="source-line-no">806</span><span id="line-806">            type = PlotAreaType.NORMAL;</span>
<span class="source-line-no">807</span><span id="line-807">        }</span>
<span class="source-line-no">808</span><span id="line-808">        if (type == PlotAreaType.NORMAL) {</span>
<span class="source-line-no">809</span><span id="line-809">            if (getPlotAreaManager().getPlotAreas(world, null).length != 0) {</span>
<span class="source-line-no">810</span><span id="line-810">                return;</span>
<span class="source-line-no">811</span><span id="line-811">            }</span>
<span class="source-line-no">812</span><span id="line-812">            IndependentPlotGenerator plotGenerator;</span>
<span class="source-line-no">813</span><span id="line-813">            if (baseGenerator != null &amp;&amp; baseGenerator.isFull()) {</span>
<span class="source-line-no">814</span><span id="line-814">                plotGenerator = baseGenerator.getPlotGenerator();</span>
<span class="source-line-no">815</span><span id="line-815">            } else if (worldSection != null) {</span>
<span class="source-line-no">816</span><span id="line-816">                String secondaryGeneratorName = worldSection.getString("generator.plugin");</span>
<span class="source-line-no">817</span><span id="line-817">                GeneratorWrapper&lt;?&gt; secondaryGenerator =</span>
<span class="source-line-no">818</span><span id="line-818">                        this.platform.getGenerator(world, secondaryGeneratorName);</span>
<span class="source-line-no">819</span><span id="line-819">                if (secondaryGenerator != null &amp;&amp; secondaryGenerator.isFull()) {</span>
<span class="source-line-no">820</span><span id="line-820">                    plotGenerator = secondaryGenerator.getPlotGenerator();</span>
<span class="source-line-no">821</span><span id="line-821">                } else {</span>
<span class="source-line-no">822</span><span id="line-822">                    String primaryGeneratorName = worldSection.getString("generator.init");</span>
<span class="source-line-no">823</span><span id="line-823">                    GeneratorWrapper&lt;?&gt; primaryGenerator =</span>
<span class="source-line-no">824</span><span id="line-824">                            this.platform.getGenerator(world, primaryGeneratorName);</span>
<span class="source-line-no">825</span><span id="line-825">                    if (primaryGenerator != null &amp;&amp; primaryGenerator.isFull()) {</span>
<span class="source-line-no">826</span><span id="line-826">                        plotGenerator = primaryGenerator.getPlotGenerator();</span>
<span class="source-line-no">827</span><span id="line-827">                    } else {</span>
<span class="source-line-no">828</span><span id="line-828">                        return;</span>
<span class="source-line-no">829</span><span id="line-829">                    }</span>
<span class="source-line-no">830</span><span id="line-830">                }</span>
<span class="source-line-no">831</span><span id="line-831">            } else {</span>
<span class="source-line-no">832</span><span id="line-832">                return;</span>
<span class="source-line-no">833</span><span id="line-833">            }</span>
<span class="source-line-no">834</span><span id="line-834">            // Conventional plot generator</span>
<span class="source-line-no">835</span><span id="line-835">            PlotArea plotArea = plotGenerator.getNewPlotArea(world, null, null, null);</span>
<span class="source-line-no">836</span><span id="line-836">            PlotManager plotManager = plotArea.getPlotManager();</span>
<span class="source-line-no">837</span><span id="line-837">            LOGGER.info("Detected world load for '{}'", world);</span>
<span class="source-line-no">838</span><span id="line-838">            LOGGER.info("- generator: {}&gt;{}", baseGenerator, plotGenerator);</span>
<span class="source-line-no">839</span><span id="line-839">            LOGGER.info("- plot world: {}", plotArea.getClass().getCanonicalName());</span>
<span class="source-line-no">840</span><span id="line-840">            LOGGER.info("- plot area manager: {}", plotManager.getClass().getCanonicalName());</span>
<span class="source-line-no">841</span><span id="line-841">            if (!this.worldConfiguration.contains(path)) {</span>
<span class="source-line-no">842</span><span id="line-842">                this.worldConfiguration.createSection(path);</span>
<span class="source-line-no">843</span><span id="line-843">                worldSection = this.worldConfiguration.getConfigurationSection(path);</span>
<span class="source-line-no">844</span><span id="line-844">            }</span>
<span class="source-line-no">845</span><span id="line-845">            plotArea.saveConfiguration(worldSection);</span>
<span class="source-line-no">846</span><span id="line-846">            plotArea.loadDefaultConfiguration(worldSection);</span>
<span class="source-line-no">847</span><span id="line-847">            try {</span>
<span class="source-line-no">848</span><span id="line-848">                this.worldConfiguration.save(this.worldsFile);</span>
<span class="source-line-no">849</span><span id="line-849">            } catch (IOException e) {</span>
<span class="source-line-no">850</span><span id="line-850">                e.printStackTrace();</span>
<span class="source-line-no">851</span><span id="line-851">            }</span>
<span class="source-line-no">852</span><span id="line-852">            // Now add it</span>
<span class="source-line-no">853</span><span id="line-853">            addPlotArea(plotArea);</span>
<span class="source-line-no">854</span><span id="line-854">            plotGenerator.initialize(plotArea);</span>
<span class="source-line-no">855</span><span id="line-855">        } else {</span>
<span class="source-line-no">856</span><span id="line-856">            if (!worlds.contains(world)) {</span>
<span class="source-line-no">857</span><span id="line-857">                return;</span>
<span class="source-line-no">858</span><span id="line-858">            }</span>
<span class="source-line-no">859</span><span id="line-859">            ConfigurationSection areasSection = worldSection.getConfigurationSection("areas");</span>
<span class="source-line-no">860</span><span id="line-860">            if (areasSection == null) {</span>
<span class="source-line-no">861</span><span id="line-861">                if (getPlotAreaManager().getPlotAreas(world, null).length != 0) {</span>
<span class="source-line-no">862</span><span id="line-862">                    return;</span>
<span class="source-line-no">863</span><span id="line-863">                }</span>
<span class="source-line-no">864</span><span id="line-864">                LOGGER.info("Detected world load for '{}'", world);</span>
<span class="source-line-no">865</span><span id="line-865">                String gen_string = worldSection.getString("generator.plugin", platform.pluginName());</span>
<span class="source-line-no">866</span><span id="line-866">                if (type == PlotAreaType.PARTIAL) {</span>
<span class="source-line-no">867</span><span id="line-867">                    Set&lt;PlotCluster&gt; clusters =</span>
<span class="source-line-no">868</span><span id="line-868">                            this.clustersTmp != null ? this.clustersTmp.get(world) : new HashSet&lt;&gt;();</span>
<span class="source-line-no">869</span><span id="line-869">                    if (clusters == null) {</span>
<span class="source-line-no">870</span><span id="line-870">                        throw new IllegalArgumentException("No cluster exists for world: " + world);</span>
<span class="source-line-no">871</span><span id="line-871">                    }</span>
<span class="source-line-no">872</span><span id="line-872">                    ArrayDeque&lt;PlotArea&gt; toLoad = new ArrayDeque&lt;&gt;();</span>
<span class="source-line-no">873</span><span id="line-873">                    for (PlotCluster cluster : clusters) {</span>
<span class="source-line-no">874</span><span id="line-874">                        PlotId pos1 = cluster.getP1(); // Cluster pos1</span>
<span class="source-line-no">875</span><span id="line-875">                        PlotId pos2 = cluster.getP2(); // Cluster pos2</span>
<span class="source-line-no">876</span><span id="line-876">                        String name = cluster.getName(); // Cluster name</span>
<span class="source-line-no">877</span><span id="line-877">                        String fullId = name + "-" + pos1 + "-" + pos2;</span>
<span class="source-line-no">878</span><span id="line-878">                        worldSection.createSection("areas." + fullId);</span>
<span class="source-line-no">879</span><span id="line-879">                        DBFunc.replaceWorld(world, world + ";" + name, pos1, pos2); // NPE</span>
<span class="source-line-no">880</span><span id="line-880">                        LOGGER.info("- {}-{}-{}", name, pos1, pos2);</span>
<span class="source-line-no">881</span><span id="line-881">                        GeneratorWrapper&lt;?&gt; areaGen = this.platform.getGenerator(world, gen_string);</span>
<span class="source-line-no">882</span><span id="line-882">                        if (areaGen == null) {</span>
<span class="source-line-no">883</span><span id="line-883">                            throw new IllegalArgumentException("Invalid Generator: " + gen_string);</span>
<span class="source-line-no">884</span><span id="line-884">                        }</span>
<span class="source-line-no">885</span><span id="line-885">                        PlotArea pa =</span>
<span class="source-line-no">886</span><span id="line-886">                                areaGen.getPlotGenerator().getNewPlotArea(world, name, pos1, pos2);</span>
<span class="source-line-no">887</span><span id="line-887">                        pa.saveConfiguration(worldSection);</span>
<span class="source-line-no">888</span><span id="line-888">                        pa.loadDefaultConfiguration(worldSection);</span>
<span class="source-line-no">889</span><span id="line-889">                        try {</span>
<span class="source-line-no">890</span><span id="line-890">                            this.worldConfiguration.save(this.worldsFile);</span>
<span class="source-line-no">891</span><span id="line-891">                        } catch (IOException e) {</span>
<span class="source-line-no">892</span><span id="line-892">                            e.printStackTrace();</span>
<span class="source-line-no">893</span><span id="line-893">                        }</span>
<span class="source-line-no">894</span><span id="line-894">                        LOGGER.info("| generator: {}&gt;{}", baseGenerator, areaGen);</span>
<span class="source-line-no">895</span><span id="line-895">                        LOGGER.info("| plot world: {}", pa.getClass().getCanonicalName());</span>
<span class="source-line-no">896</span><span id="line-896">                        LOGGER.info("| manager: {}", pa.getPlotManager().getClass().getCanonicalName());</span>
<span class="source-line-no">897</span><span id="line-897">                        LOGGER.info("Note: Area created for cluster '{}' (invalid or old configuration?)", name);</span>
<span class="source-line-no">898</span><span id="line-898">                        areaGen.getPlotGenerator().initialize(pa);</span>
<span class="source-line-no">899</span><span id="line-899">                        areaGen.augment(pa);</span>
<span class="source-line-no">900</span><span id="line-900">                        toLoad.add(pa);</span>
<span class="source-line-no">901</span><span id="line-901">                    }</span>
<span class="source-line-no">902</span><span id="line-902">                    for (PlotArea area : toLoad) {</span>
<span class="source-line-no">903</span><span id="line-903">                        addPlotArea(area);</span>
<span class="source-line-no">904</span><span id="line-904">                    }</span>
<span class="source-line-no">905</span><span id="line-905">                    return;</span>
<span class="source-line-no">906</span><span id="line-906">                }</span>
<span class="source-line-no">907</span><span id="line-907">                GeneratorWrapper&lt;?&gt; areaGen = this.platform.getGenerator(world, gen_string);</span>
<span class="source-line-no">908</span><span id="line-908">                if (areaGen == null) {</span>
<span class="source-line-no">909</span><span id="line-909">                    throw new IllegalArgumentException("Invalid Generator: " + gen_string);</span>
<span class="source-line-no">910</span><span id="line-910">                }</span>
<span class="source-line-no">911</span><span id="line-911">                PlotArea pa = areaGen.getPlotGenerator().getNewPlotArea(world, null, null, null);</span>
<span class="source-line-no">912</span><span id="line-912">                LOGGER.info("- generator: {}&gt;{}", baseGenerator, areaGen);</span>
<span class="source-line-no">913</span><span id="line-913">                LOGGER.info("- plot world: {}", pa.getClass().getCanonicalName());</span>
<span class="source-line-no">914</span><span id="line-914">                LOGGER.info("- plot area manager: {}", pa.getPlotManager().getClass().getCanonicalName());</span>
<span class="source-line-no">915</span><span id="line-915">                if (!this.worldConfiguration.contains(path)) {</span>
<span class="source-line-no">916</span><span id="line-916">                    this.worldConfiguration.createSection(path);</span>
<span class="source-line-no">917</span><span id="line-917">                    worldSection = this.worldConfiguration.getConfigurationSection(path);</span>
<span class="source-line-no">918</span><span id="line-918">                }</span>
<span class="source-line-no">919</span><span id="line-919">                pa.saveConfiguration(worldSection);</span>
<span class="source-line-no">920</span><span id="line-920">                pa.loadDefaultConfiguration(worldSection);</span>
<span class="source-line-no">921</span><span id="line-921">                try {</span>
<span class="source-line-no">922</span><span id="line-922">                    this.worldConfiguration.save(this.worldsFile);</span>
<span class="source-line-no">923</span><span id="line-923">                } catch (IOException e) {</span>
<span class="source-line-no">924</span><span id="line-924">                    e.printStackTrace();</span>
<span class="source-line-no">925</span><span id="line-925">                }</span>
<span class="source-line-no">926</span><span id="line-926">                areaGen.getPlotGenerator().initialize(pa);</span>
<span class="source-line-no">927</span><span id="line-927">                areaGen.augment(pa);</span>
<span class="source-line-no">928</span><span id="line-928">                addPlotArea(pa);</span>
<span class="source-line-no">929</span><span id="line-929">                return;</span>
<span class="source-line-no">930</span><span id="line-930">            }</span>
<span class="source-line-no">931</span><span id="line-931">            if (type == PlotAreaType.AUGMENTED) {</span>
<span class="source-line-no">932</span><span id="line-932">                throw new IllegalArgumentException(</span>
<span class="source-line-no">933</span><span id="line-933">                        "Invalid type for multi-area world. Expected `PARTIAL`, got `"</span>
<span class="source-line-no">934</span><span id="line-934">                                + PlotAreaType.AUGMENTED + "`");</span>
<span class="source-line-no">935</span><span id="line-935">            }</span>
<span class="source-line-no">936</span><span id="line-936">            for (String areaId : areasSection.getKeys(false)) {</span>
<span class="source-line-no">937</span><span id="line-937">                LOGGER.info("- {}", areaId);</span>
<span class="source-line-no">938</span><span id="line-938">                String[] split = areaId.split("(?&lt;=[^;-])-");</span>
<span class="source-line-no">939</span><span id="line-939">                if (split.length != 3) {</span>
<span class="source-line-no">940</span><span id="line-940">                    throw new IllegalArgumentException("Invalid Area identifier: " + areaId</span>
<span class="source-line-no">941</span><span id="line-941">                            + ". Expected form `&lt;name&gt;-&lt;pos1&gt;-&lt;pos2&gt;`");</span>
<span class="source-line-no">942</span><span id="line-942">                }</span>
<span class="source-line-no">943</span><span id="line-943">                String name = split[0];</span>
<span class="source-line-no">944</span><span id="line-944">                PlotId pos1 = PlotId.fromString(split[1]);</span>
<span class="source-line-no">945</span><span id="line-945">                PlotId pos2 = PlotId.fromString(split[2]);</span>
<span class="source-line-no">946</span><span id="line-946">                if (name.isEmpty()) {</span>
<span class="source-line-no">947</span><span id="line-947">                    throw new IllegalArgumentException("Invalid Area identifier: " + areaId</span>
<span class="source-line-no">948</span><span id="line-948">                            + ". Expected form `&lt;name&gt;-&lt;x1;z1&gt;-&lt;x2;z2&gt;`");</span>
<span class="source-line-no">949</span><span id="line-949">                }</span>
<span class="source-line-no">950</span><span id="line-950">                final PlotArea existing = this.getPlotAreaManager().getPlotArea(world, name);</span>
<span class="source-line-no">951</span><span id="line-951">                if (existing != null &amp;&amp; name.equals(existing.getId())) {</span>
<span class="source-line-no">952</span><span id="line-952">                    continue;</span>
<span class="source-line-no">953</span><span id="line-953">                }</span>
<span class="source-line-no">954</span><span id="line-954">                ConfigurationSection section = areasSection.getConfigurationSection(areaId);</span>
<span class="source-line-no">955</span><span id="line-955">                YamlConfiguration clone = new YamlConfiguration();</span>
<span class="source-line-no">956</span><span id="line-956">                for (String key : section.getKeys(true)) {</span>
<span class="source-line-no">957</span><span id="line-957">                    if (section.get(key) instanceof MemorySection) {</span>
<span class="source-line-no">958</span><span id="line-958">                        continue;</span>
<span class="source-line-no">959</span><span id="line-959">                    }</span>
<span class="source-line-no">960</span><span id="line-960">                    if (!clone.contains(key)) {</span>
<span class="source-line-no">961</span><span id="line-961">                        clone.set(key, section.get(key));</span>
<span class="source-line-no">962</span><span id="line-962">                    }</span>
<span class="source-line-no">963</span><span id="line-963">                }</span>
<span class="source-line-no">964</span><span id="line-964">                for (String key : worldSection.getKeys(true)) {</span>
<span class="source-line-no">965</span><span id="line-965">                    if (worldSection.get(key) instanceof MemorySection) {</span>
<span class="source-line-no">966</span><span id="line-966">                        continue;</span>
<span class="source-line-no">967</span><span id="line-967">                    }</span>
<span class="source-line-no">968</span><span id="line-968">                    if (!key.startsWith("areas") &amp;&amp; !clone.contains(key)) {</span>
<span class="source-line-no">969</span><span id="line-969">                        clone.set(key, worldSection.get(key));</span>
<span class="source-line-no">970</span><span id="line-970">                    }</span>
<span class="source-line-no">971</span><span id="line-971">                }</span>
<span class="source-line-no">972</span><span id="line-972">                String gen_string = clone.getString("generator.plugin", platform.pluginName());</span>
<span class="source-line-no">973</span><span id="line-973">                GeneratorWrapper&lt;?&gt; areaGen = this.platform.getGenerator(world, gen_string);</span>
<span class="source-line-no">974</span><span id="line-974">                if (areaGen == null) {</span>
<span class="source-line-no">975</span><span id="line-975">                    throw new IllegalArgumentException("Invalid Generator: " + gen_string);</span>
<span class="source-line-no">976</span><span id="line-976">                }</span>
<span class="source-line-no">977</span><span id="line-977">                PlotArea pa = areaGen.getPlotGenerator().getNewPlotArea(world, name, pos1, pos2);</span>
<span class="source-line-no">978</span><span id="line-978">                pa.saveConfiguration(clone);</span>
<span class="source-line-no">979</span><span id="line-979">                // netSections is the combination of</span>
<span class="source-line-no">980</span><span id="line-980">                for (String key : clone.getKeys(true)) {</span>
<span class="source-line-no">981</span><span id="line-981">                    if (clone.get(key) instanceof MemorySection) {</span>
<span class="source-line-no">982</span><span id="line-982">                        continue;</span>
<span class="source-line-no">983</span><span id="line-983">                    }</span>
<span class="source-line-no">984</span><span id="line-984">                    if (!worldSection.contains(key)) {</span>
<span class="source-line-no">985</span><span id="line-985">                        worldSection.set(key, clone.get(key));</span>
<span class="source-line-no">986</span><span id="line-986">                    } else {</span>
<span class="source-line-no">987</span><span id="line-987">                        Object value = worldSection.get(key);</span>
<span class="source-line-no">988</span><span id="line-988">                        if (!Objects.equals(value, clone.get(key))) {</span>
<span class="source-line-no">989</span><span id="line-989">                            section.set(key, clone.get(key));</span>
<span class="source-line-no">990</span><span id="line-990">                        }</span>
<span class="source-line-no">991</span><span id="line-991">                    }</span>
<span class="source-line-no">992</span><span id="line-992">                }</span>
<span class="source-line-no">993</span><span id="line-993">                pa.loadDefaultConfiguration(clone);</span>
<span class="source-line-no">994</span><span id="line-994">                try {</span>
<span class="source-line-no">995</span><span id="line-995">                    this.worldConfiguration.save(this.worldsFile);</span>
<span class="source-line-no">996</span><span id="line-996">                } catch (IOException e) {</span>
<span class="source-line-no">997</span><span id="line-997">                    e.printStackTrace();</span>
<span class="source-line-no">998</span><span id="line-998">                }</span>
<span class="source-line-no">999</span><span id="line-999">                LOGGER.info("Detected area load for '{}'", world);</span>
<span class="source-line-no">1000</span><span id="line-1000">                LOGGER.info("| generator: {}&gt;{}", baseGenerator, areaGen);</span>
<span class="source-line-no">1001</span><span id="line-1001">                LOGGER.info("| plot world: {}", pa);</span>
<span class="source-line-no">1002</span><span id="line-1002">                LOGGER.info("| manager: {}", pa.getPlotManager());</span>
<span class="source-line-no">1003</span><span id="line-1003">                areaGen.getPlotGenerator().initialize(pa);</span>
<span class="source-line-no">1004</span><span id="line-1004">                areaGen.augment(pa);</span>
<span class="source-line-no">1005</span><span id="line-1005">                addPlotArea(pa);</span>
<span class="source-line-no">1006</span><span id="line-1006">            }</span>
<span class="source-line-no">1007</span><span id="line-1007">        }</span>
<span class="source-line-no">1008</span><span id="line-1008">    }</span>
<span class="source-line-no">1009</span><span id="line-1009"></span>
<span class="source-line-no">1010</span><span id="line-1010">    /**</span>
<span class="source-line-no">1011</span><span id="line-1011">     * Setup the configuration for a plot world based on world arguments.</span>
<span class="source-line-no">1012</span><span id="line-1012">     *</span>
<span class="source-line-no">1013</span><span id="line-1013">     *</span>
<span class="source-line-no">1014</span><span id="line-1014">     * &lt;i&gt;e.g. /mv create &amp;lt;world&amp;gt; normal -g PlotSquared:&amp;lt;args&amp;gt;&lt;/i&gt;</span>
<span class="source-line-no">1015</span><span id="line-1015">     *</span>
<span class="source-line-no">1016</span><span id="line-1016">     * @param world     The name of the world</span>
<span class="source-line-no">1017</span><span id="line-1017">     * @param args      The arguments</span>
<span class="source-line-no">1018</span><span id="line-1018">     * @param generator the plot generator</span>
<span class="source-line-no">1019</span><span id="line-1019">     * @return boolean | if valid arguments were provided</span>
<span class="source-line-no">1020</span><span id="line-1020">     */</span>
<span class="source-line-no">1021</span><span id="line-1021">    public boolean setupPlotWorld(</span>
<span class="source-line-no">1022</span><span id="line-1022">            final @NonNull String world,</span>
<span class="source-line-no">1023</span><span id="line-1023">            final @Nullable String args,</span>
<span class="source-line-no">1024</span><span id="line-1024">            final @NonNull IndependentPlotGenerator generator</span>
<span class="source-line-no">1025</span><span id="line-1025">    ) {</span>
<span class="source-line-no">1026</span><span id="line-1026">        if (args != null &amp;&amp; !args.isEmpty()) {</span>
<span class="source-line-no">1027</span><span id="line-1027">            // save configuration</span>
<span class="source-line-no">1028</span><span id="line-1028"></span>
<span class="source-line-no">1029</span><span id="line-1029">            final List&lt;String&gt; validArguments = Arrays</span>
<span class="source-line-no">1030</span><span id="line-1030">                    .asList("s=", "size=", "g=", "gap=", "h=", "height=", "minh=", "minheight=", "maxh=", "maxheight=",</span>
<span class="source-line-no">1031</span><span id="line-1031">                            "f=", "floor=", "m=", "main=", "w=", "wall=", "b=", "border="</span>
<span class="source-line-no">1032</span><span id="line-1032">                    );</span>
<span class="source-line-no">1033</span><span id="line-1033"></span>
<span class="source-line-no">1034</span><span id="line-1034">            // Calculate the number of expected arguments</span>
<span class="source-line-no">1035</span><span id="line-1035">            int expected = (int) validArguments.stream()</span>
<span class="source-line-no">1036</span><span id="line-1036">                    .filter(validArgument -&gt; args.toLowerCase(Locale.ENGLISH).contains(validArgument))</span>
<span class="source-line-no">1037</span><span id="line-1037">                    .count();</span>
<span class="source-line-no">1038</span><span id="line-1038"></span>
<span class="source-line-no">1039</span><span id="line-1039">            String[] split = args.toLowerCase(Locale.ENGLISH).split(",(?![^\\(\\[]*[\\]\\)])");</span>
<span class="source-line-no">1040</span><span id="line-1040"></span>
<span class="source-line-no">1041</span><span id="line-1041">            if (split.length &gt; expected) {</span>
<span class="source-line-no">1042</span><span id="line-1042">                // This means we have multi-block block buckets</span>
<span class="source-line-no">1043</span><span id="line-1043">                String[] combinedArgs = new String[expected];</span>
<span class="source-line-no">1044</span><span id="line-1044">                int index = 0;</span>
<span class="source-line-no">1045</span><span id="line-1045"></span>
<span class="source-line-no">1046</span><span id="line-1046">                StringBuilder argBuilder = new StringBuilder();</span>
<span class="source-line-no">1047</span><span id="line-1047">                outer:</span>
<span class="source-line-no">1048</span><span id="line-1048">                for (final String string : split) {</span>
<span class="source-line-no">1049</span><span id="line-1049">                    for (final String validArgument : validArguments) {</span>
<span class="source-line-no">1050</span><span id="line-1050">                        if (string.contains(validArgument)) {</span>
<span class="source-line-no">1051</span><span id="line-1051">                            if (!argBuilder.toString().isEmpty()) {</span>
<span class="source-line-no">1052</span><span id="line-1052">                                combinedArgs[index++] = argBuilder.toString();</span>
<span class="source-line-no">1053</span><span id="line-1053">                                argBuilder = new StringBuilder();</span>
<span class="source-line-no">1054</span><span id="line-1054">                            }</span>
<span class="source-line-no">1055</span><span id="line-1055">                            argBuilder.append(string);</span>
<span class="source-line-no">1056</span><span id="line-1056">                            continue outer;</span>
<span class="source-line-no">1057</span><span id="line-1057">                        }</span>
<span class="source-line-no">1058</span><span id="line-1058">                    }</span>
<span class="source-line-no">1059</span><span id="line-1059">                    if (argBuilder.toString().charAt(argBuilder.length() - 1) != '=') {</span>
<span class="source-line-no">1060</span><span id="line-1060">                        argBuilder.append(",");</span>
<span class="source-line-no">1061</span><span id="line-1061">                    }</span>
<span class="source-line-no">1062</span><span id="line-1062">                    argBuilder.append(string);</span>
<span class="source-line-no">1063</span><span id="line-1063">                }</span>
<span class="source-line-no">1064</span><span id="line-1064"></span>
<span class="source-line-no">1065</span><span id="line-1065">                if (!argBuilder.toString().isEmpty()) {</span>
<span class="source-line-no">1066</span><span id="line-1066">                    combinedArgs[index] = argBuilder.toString();</span>
<span class="source-line-no">1067</span><span id="line-1067">                }</span>
<span class="source-line-no">1068</span><span id="line-1068"></span>
<span class="source-line-no">1069</span><span id="line-1069">                split = combinedArgs;</span>
<span class="source-line-no">1070</span><span id="line-1070">            }</span>
<span class="source-line-no">1071</span><span id="line-1071"></span>
<span class="source-line-no">1072</span><span id="line-1072">            final HybridPlotWorldFactory hybridPlotWorldFactory = this.platform</span>
<span class="source-line-no">1073</span><span id="line-1073">                    .injector()</span>
<span class="source-line-no">1074</span><span id="line-1074">                    .getInstance(HybridPlotWorldFactory.class);</span>
<span class="source-line-no">1075</span><span id="line-1075">            final HybridPlotWorld plotWorld = hybridPlotWorldFactory.create(world, null, generator, null, null);</span>
<span class="source-line-no">1076</span><span id="line-1076"></span>
<span class="source-line-no">1077</span><span id="line-1077">            for (String element : split) {</span>
<span class="source-line-no">1078</span><span id="line-1078">                String[] pair = element.split("=");</span>
<span class="source-line-no">1079</span><span id="line-1079">                if (pair.length != 2) {</span>
<span class="source-line-no">1080</span><span id="line-1080">                    LOGGER.error("No value provided for '{}'", element);</span>
<span class="source-line-no">1081</span><span id="line-1081">                    return false;</span>
<span class="source-line-no">1082</span><span id="line-1082">                }</span>
<span class="source-line-no">1083</span><span id="line-1083">                String key = pair[0].toLowerCase();</span>
<span class="source-line-no">1084</span><span id="line-1084">                String value = pair[1];</span>
<span class="source-line-no">1085</span><span id="line-1085">                try {</span>
<span class="source-line-no">1086</span><span id="line-1086">                    String base = "worlds." + world + ".";</span>
<span class="source-line-no">1087</span><span id="line-1087">                    switch (key) {</span>
<span class="source-line-no">1088</span><span id="line-1088">                        case "s", "size" -&gt; this.worldConfiguration.set(</span>
<span class="source-line-no">1089</span><span id="line-1089">                                base + "plot.size",</span>
<span class="source-line-no">1090</span><span id="line-1090">                                ConfigurationUtil.INTEGER.parseString(value).shortValue()</span>
<span class="source-line-no">1091</span><span id="line-1091">                        );</span>
<span class="source-line-no">1092</span><span id="line-1092">                        case "g", "gap" -&gt; this.worldConfiguration.set(</span>
<span class="source-line-no">1093</span><span id="line-1093">                                base + "road.width",</span>
<span class="source-line-no">1094</span><span id="line-1094">                                ConfigurationUtil.INTEGER.parseString(value).shortValue()</span>
<span class="source-line-no">1095</span><span id="line-1095">                        );</span>
<span class="source-line-no">1096</span><span id="line-1096">                        case "h", "height" -&gt; {</span>
<span class="source-line-no">1097</span><span id="line-1097">                            this.worldConfiguration.set(</span>
<span class="source-line-no">1098</span><span id="line-1098">                                    base + "road.height",</span>
<span class="source-line-no">1099</span><span id="line-1099">                                    ConfigurationUtil.INTEGER.parseString(value).shortValue()</span>
<span class="source-line-no">1100</span><span id="line-1100">                            );</span>
<span class="source-line-no">1101</span><span id="line-1101">                            this.worldConfiguration.set(</span>
<span class="source-line-no">1102</span><span id="line-1102">                                    base + "plot.height",</span>
<span class="source-line-no">1103</span><span id="line-1103">                                    ConfigurationUtil.INTEGER.parseString(value).shortValue()</span>
<span class="source-line-no">1104</span><span id="line-1104">                            );</span>
<span class="source-line-no">1105</span><span id="line-1105">                            this.worldConfiguration.set(</span>
<span class="source-line-no">1106</span><span id="line-1106">                                    base + "wall.height",</span>
<span class="source-line-no">1107</span><span id="line-1107">                                    ConfigurationUtil.INTEGER.parseString(value).shortValue()</span>
<span class="source-line-no">1108</span><span id="line-1108">                            );</span>
<span class="source-line-no">1109</span><span id="line-1109">                        }</span>
<span class="source-line-no">1110</span><span id="line-1110">                        case "minh", "minheight" -&gt; this.worldConfiguration.set(</span>
<span class="source-line-no">1111</span><span id="line-1111">                                base + "world.min_gen_height",</span>
<span class="source-line-no">1112</span><span id="line-1112">                                ConfigurationUtil.INTEGER.parseString(value).shortValue()</span>
<span class="source-line-no">1113</span><span id="line-1113">                        );</span>
<span class="source-line-no">1114</span><span id="line-1114">                        case "maxh", "maxheight" -&gt; this.worldConfiguration.set(</span>
<span class="source-line-no">1115</span><span id="line-1115">                                base + "world.max_gen_height",</span>
<span class="source-line-no">1116</span><span id="line-1116">                                ConfigurationUtil.INTEGER.parseString(value).shortValue()</span>
<span class="source-line-no">1117</span><span id="line-1117">                        );</span>
<span class="source-line-no">1118</span><span id="line-1118">                        case "f", "floor" -&gt; this.worldConfiguration.set(</span>
<span class="source-line-no">1119</span><span id="line-1119">                                base + "plot.floor",</span>
<span class="source-line-no">1120</span><span id="line-1120">                                ConfigurationUtil.BLOCK_BUCKET.parseString(value).toString()</span>
<span class="source-line-no">1121</span><span id="line-1121">                        );</span>
<span class="source-line-no">1122</span><span id="line-1122">                        case "m", "main" -&gt; this.worldConfiguration.set(</span>
<span class="source-line-no">1123</span><span id="line-1123">                                base + "plot.filling",</span>
<span class="source-line-no">1124</span><span id="line-1124">                                ConfigurationUtil.BLOCK_BUCKET.parseString(value).toString()</span>
<span class="source-line-no">1125</span><span id="line-1125">                        );</span>
<span class="source-line-no">1126</span><span id="line-1126">                        case "w", "wall" -&gt; this.worldConfiguration.set(</span>
<span class="source-line-no">1127</span><span id="line-1127">                                base + "wall.filling",</span>
<span class="source-line-no">1128</span><span id="line-1128">                                ConfigurationUtil.BLOCK_BUCKET.parseString(value).toString()</span>
<span class="source-line-no">1129</span><span id="line-1129">                        );</span>
<span class="source-line-no">1130</span><span id="line-1130">                        case "b", "border" -&gt; this.worldConfiguration.set(</span>
<span class="source-line-no">1131</span><span id="line-1131">                                base + "wall.block",</span>
<span class="source-line-no">1132</span><span id="line-1132">                                ConfigurationUtil.BLOCK_BUCKET.parseString(value).toString()</span>
<span class="source-line-no">1133</span><span id="line-1133">                        );</span>
<span class="source-line-no">1134</span><span id="line-1134">                        default -&gt; {</span>
<span class="source-line-no">1135</span><span id="line-1135">                            LOGGER.error("Key not found: {}", element);</span>
<span class="source-line-no">1136</span><span id="line-1136">                            return false;</span>
<span class="source-line-no">1137</span><span id="line-1137">                        }</span>
<span class="source-line-no">1138</span><span id="line-1138">                    }</span>
<span class="source-line-no">1139</span><span id="line-1139">                } catch (Exception e) {</span>
<span class="source-line-no">1140</span><span id="line-1140">                    LOGGER.error("Invalid value '{}' for arg '{}'", value, element);</span>
<span class="source-line-no">1141</span><span id="line-1141">                    e.printStackTrace();</span>
<span class="source-line-no">1142</span><span id="line-1142">                    return false;</span>
<span class="source-line-no">1143</span><span id="line-1143">                }</span>
<span class="source-line-no">1144</span><span id="line-1144">            }</span>
<span class="source-line-no">1145</span><span id="line-1145">            try {</span>
<span class="source-line-no">1146</span><span id="line-1146">                ConfigurationSection section =</span>
<span class="source-line-no">1147</span><span id="line-1147">                        this.worldConfiguration.getConfigurationSection("worlds." + world);</span>
<span class="source-line-no">1148</span><span id="line-1148">                plotWorld.saveConfiguration(section);</span>
<span class="source-line-no">1149</span><span id="line-1149">                plotWorld.loadDefaultConfiguration(section);</span>
<span class="source-line-no">1150</span><span id="line-1150">                this.worldConfiguration.save(this.worldsFile);</span>
<span class="source-line-no">1151</span><span id="line-1151">            } catch (IOException e) {</span>
<span class="source-line-no">1152</span><span id="line-1152">                e.printStackTrace();</span>
<span class="source-line-no">1153</span><span id="line-1153">            }</span>
<span class="source-line-no">1154</span><span id="line-1154">        }</span>
<span class="source-line-no">1155</span><span id="line-1155">        return true;</span>
<span class="source-line-no">1156</span><span id="line-1156">    }</span>
<span class="source-line-no">1157</span><span id="line-1157"></span>
<span class="source-line-no">1158</span><span id="line-1158">    /**</span>
<span class="source-line-no">1159</span><span id="line-1159">     * Copies a file from inside the jar to a location</span>
<span class="source-line-no">1160</span><span id="line-1160">     *</span>
<span class="source-line-no">1161</span><span id="line-1161">     * @param file   Name of the file inside PlotSquared.jar</span>
<span class="source-line-no">1162</span><span id="line-1162">     * @param folder The output location relative to /plugins/PlotSquared/</span>
<span class="source-line-no">1163</span><span id="line-1163">     */</span>
<span class="source-line-no">1164</span><span id="line-1164">    public void copyFile(</span>
<span class="source-line-no">1165</span><span id="line-1165">            final @NonNull String file,</span>
<span class="source-line-no">1166</span><span id="line-1166">            final @NonNull String folder</span>
<span class="source-line-no">1167</span><span id="line-1167">    ) {</span>
<span class="source-line-no">1168</span><span id="line-1168">        try {</span>
<span class="source-line-no">1169</span><span id="line-1169">            File output = this.platform.getDirectory();</span>
<span class="source-line-no">1170</span><span id="line-1170">            if (!output.exists()) {</span>
<span class="source-line-no">1171</span><span id="line-1171">                output.mkdirs();</span>
<span class="source-line-no">1172</span><span id="line-1172">            }</span>
<span class="source-line-no">1173</span><span id="line-1173">            File newFile = FileUtils.getFile(output, folder + File.separator + file);</span>
<span class="source-line-no">1174</span><span id="line-1174">            if (newFile.exists()) {</span>
<span class="source-line-no">1175</span><span id="line-1175">                return;</span>
<span class="source-line-no">1176</span><span id="line-1176">            }</span>
<span class="source-line-no">1177</span><span id="line-1177">            try (InputStream stream = this.platform.getClass().getResourceAsStream(file)) {</span>
<span class="source-line-no">1178</span><span id="line-1178">                byte[] buffer = new byte[2048];</span>
<span class="source-line-no">1179</span><span id="line-1179">                if (stream == null) {</span>
<span class="source-line-no">1180</span><span id="line-1180">                    try (ZipInputStream zis = new ZipInputStream(</span>
<span class="source-line-no">1181</span><span id="line-1181">                            new FileInputStream(this.jarFile))) {</span>
<span class="source-line-no">1182</span><span id="line-1182">                        ZipEntry ze = zis.getNextEntry();</span>
<span class="source-line-no">1183</span><span id="line-1183">                        while (ze != null) {</span>
<span class="source-line-no">1184</span><span id="line-1184">                            String name = ze.getName();</span>
<span class="source-line-no">1185</span><span id="line-1185">                            if (name.equals(file)) {</span>
<span class="source-line-no">1186</span><span id="line-1186">                                new File(newFile.getParent()).mkdirs();</span>
<span class="source-line-no">1187</span><span id="line-1187">                                try (FileOutputStream fos = new FileOutputStream(newFile)) {</span>
<span class="source-line-no">1188</span><span id="line-1188">                                    int len;</span>
<span class="source-line-no">1189</span><span id="line-1189">                                    while ((len = zis.read(buffer)) &gt; 0) {</span>
<span class="source-line-no">1190</span><span id="line-1190">                                        fos.write(buffer, 0, len);</span>
<span class="source-line-no">1191</span><span id="line-1191">                                    }</span>
<span class="source-line-no">1192</span><span id="line-1192">                                }</span>
<span class="source-line-no">1193</span><span id="line-1193">                                ze = null;</span>
<span class="source-line-no">1194</span><span id="line-1194">                            } else {</span>
<span class="source-line-no">1195</span><span id="line-1195">                                ze = zis.getNextEntry();</span>
<span class="source-line-no">1196</span><span id="line-1196">                            }</span>
<span class="source-line-no">1197</span><span id="line-1197">                        }</span>
<span class="source-line-no">1198</span><span id="line-1198">                        zis.closeEntry();</span>
<span class="source-line-no">1199</span><span id="line-1199">                    }</span>
<span class="source-line-no">1200</span><span id="line-1200">                    return;</span>
<span class="source-line-no">1201</span><span id="line-1201">                }</span>
<span class="source-line-no">1202</span><span id="line-1202">                newFile.createNewFile();</span>
<span class="source-line-no">1203</span><span id="line-1203">                try (FileOutputStream fos = new FileOutputStream(newFile)) {</span>
<span class="source-line-no">1204</span><span id="line-1204">                    int len;</span>
<span class="source-line-no">1205</span><span id="line-1205">                    while ((len = stream.read(buffer)) &gt; 0) {</span>
<span class="source-line-no">1206</span><span id="line-1206">                        fos.write(buffer, 0, len);</span>
<span class="source-line-no">1207</span><span id="line-1207">                    }</span>
<span class="source-line-no">1208</span><span id="line-1208">                }</span>
<span class="source-line-no">1209</span><span id="line-1209">            }</span>
<span class="source-line-no">1210</span><span id="line-1210">        } catch (IOException e) {</span>
<span class="source-line-no">1211</span><span id="line-1211">            LOGGER.error("Could not save {}", file);</span>
<span class="source-line-no">1212</span><span id="line-1212">            e.printStackTrace();</span>
<span class="source-line-no">1213</span><span id="line-1213">        }</span>
<span class="source-line-no">1214</span><span id="line-1214">    }</span>
<span class="source-line-no">1215</span><span id="line-1215"></span>
<span class="source-line-no">1216</span><span id="line-1216">    /**</span>
<span class="source-line-no">1217</span><span id="line-1217">     * Safely closes the database connection.</span>
<span class="source-line-no">1218</span><span id="line-1218">     */</span>
<span class="source-line-no">1219</span><span id="line-1219">    public void disable() {</span>
<span class="source-line-no">1220</span><span id="line-1220">        try {</span>
<span class="source-line-no">1221</span><span id="line-1221">            eventDispatcher.unregisterAll();</span>
<span class="source-line-no">1222</span><span id="line-1222">            checkRoadRegenPersistence();</span>
<span class="source-line-no">1223</span><span id="line-1223">            // Validate that all data in the db is correct</span>
<span class="source-line-no">1224</span><span id="line-1224">            final HashSet&lt;Plot&gt; plots = new HashSet&lt;&gt;();</span>
<span class="source-line-no">1225</span><span id="line-1225">            try {</span>
<span class="source-line-no">1226</span><span id="line-1226">                forEachPlotRaw(plots::add);</span>
<span class="source-line-no">1227</span><span id="line-1227">            } catch (final Exception ignored) {</span>
<span class="source-line-no">1228</span><span id="line-1228">            }</span>
<span class="source-line-no">1229</span><span id="line-1229">            DBFunc.validatePlots(plots);</span>
<span class="source-line-no">1230</span><span id="line-1230"></span>
<span class="source-line-no">1231</span><span id="line-1231">            // Close the connection</span>
<span class="source-line-no">1232</span><span id="line-1232">            DBFunc.close();</span>
<span class="source-line-no">1233</span><span id="line-1233">        } catch (NullPointerException throwable) {</span>
<span class="source-line-no">1234</span><span id="line-1234">            LOGGER.error("Could not close database connection", throwable);</span>
<span class="source-line-no">1235</span><span id="line-1235">            throwable.printStackTrace();</span>
<span class="source-line-no">1236</span><span id="line-1236">        }</span>
<span class="source-line-no">1237</span><span id="line-1237">    }</span>
<span class="source-line-no">1238</span><span id="line-1238"></span>
<span class="source-line-no">1239</span><span id="line-1239">    /**</span>
<span class="source-line-no">1240</span><span id="line-1240">     * Handle road regen persistence</span>
<span class="source-line-no">1241</span><span id="line-1241">     */</span>
<span class="source-line-no">1242</span><span id="line-1242">    private void checkRoadRegenPersistence() {</span>
<span class="source-line-no">1243</span><span id="line-1243">        if (!HybridUtils.UPDATE || !Settings.Enabled_Components.PERSISTENT_ROAD_REGEN || (</span>
<span class="source-line-no">1244</span><span id="line-1244">                HybridUtils.regions.isEmpty() &amp;&amp; HybridUtils.chunks.isEmpty())) {</span>
<span class="source-line-no">1245</span><span id="line-1245">            return;</span>
<span class="source-line-no">1246</span><span id="line-1246">        }</span>
<span class="source-line-no">1247</span><span id="line-1247">        LOGGER.info("Road regeneration incomplete. Saving incomplete regions to disk");</span>
<span class="source-line-no">1248</span><span id="line-1248">        LOGGER.info("- regions: {}", HybridUtils.regions.size());</span>
<span class="source-line-no">1249</span><span id="line-1249">        LOGGER.info("- chunks: {}", HybridUtils.chunks.size());</span>
<span class="source-line-no">1250</span><span id="line-1250">        ArrayList&lt;int[]&gt; regions = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">1251</span><span id="line-1251">        ArrayList&lt;int[]&gt; chunks = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">1252</span><span id="line-1252">        for (BlockVector2 r : HybridUtils.regions) {</span>
<span class="source-line-no">1253</span><span id="line-1253">            regions.add(new int[]{r.getBlockX(), r.getBlockZ()});</span>
<span class="source-line-no">1254</span><span id="line-1254">        }</span>
<span class="source-line-no">1255</span><span id="line-1255">        for (BlockVector2 c : HybridUtils.chunks) {</span>
<span class="source-line-no">1256</span><span id="line-1256">            chunks.add(new int[]{c.getBlockX(), c.getBlockZ()});</span>
<span class="source-line-no">1257</span><span id="line-1257">        }</span>
<span class="source-line-no">1258</span><span id="line-1258">        List&lt;Object&gt; list = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">1259</span><span id="line-1259">        list.add(regions);</span>
<span class="source-line-no">1260</span><span id="line-1260">        list.add(chunks);</span>
<span class="source-line-no">1261</span><span id="line-1261">        list.add(HybridUtils.height);</span>
<span class="source-line-no">1262</span><span id="line-1262">        File file = new File(</span>
<span class="source-line-no">1263</span><span id="line-1263">                this.platform.getDirectory() + File.separator + "persistent_regen_data_" + HybridUtils.area</span>
<span class="source-line-no">1264</span><span id="line-1264">                        .getId() + "_" + HybridUtils.area.getWorldName());</span>
<span class="source-line-no">1265</span><span id="line-1265">        if (file.exists() &amp;&amp; !file.delete()) {</span>
<span class="source-line-no">1266</span><span id="line-1266">            LOGGER.error("persistent_regene_data file already exists and could not be deleted");</span>
<span class="source-line-no">1267</span><span id="line-1267">            return;</span>
<span class="source-line-no">1268</span><span id="line-1268">        }</span>
<span class="source-line-no">1269</span><span id="line-1269">        try (ObjectOutputStream oos = new ObjectOutputStream(</span>
<span class="source-line-no">1270</span><span id="line-1270">                Files.newOutputStream(file.toPath(), StandardOpenOption.CREATE_NEW))) {</span>
<span class="source-line-no">1271</span><span id="line-1271">            oos.writeObject(list);</span>
<span class="source-line-no">1272</span><span id="line-1272">        } catch (IOException e) {</span>
<span class="source-line-no">1273</span><span id="line-1273">            LOGGER.error("Error creating persistent_region_data file", e);</span>
<span class="source-line-no">1274</span><span id="line-1274">        }</span>
<span class="source-line-no">1275</span><span id="line-1275">    }</span>
<span class="source-line-no">1276</span><span id="line-1276"></span>
<span class="source-line-no">1277</span><span id="line-1277">    /**</span>
<span class="source-line-no">1278</span><span id="line-1278">     * Setup the database connection.</span>
<span class="source-line-no">1279</span><span id="line-1279">     */</span>
<span class="source-line-no">1280</span><span id="line-1280">    public void setupDatabase() {</span>
<span class="source-line-no">1281</span><span id="line-1281">        try {</span>
<span class="source-line-no">1282</span><span id="line-1282">            if (DBFunc.dbManager != null) {</span>
<span class="source-line-no">1283</span><span id="line-1283">                DBFunc.dbManager.close();</span>
<span class="source-line-no">1284</span><span id="line-1284">            }</span>
<span class="source-line-no">1285</span><span id="line-1285">            Database database;</span>
<span class="source-line-no">1286</span><span id="line-1286">            if (Storage.MySQL.USE) {</span>
<span class="source-line-no">1287</span><span id="line-1287">                database = new MySQL(Storage.MySQL.HOST, Storage.MySQL.PORT, Storage.MySQL.DATABASE,</span>
<span class="source-line-no">1288</span><span id="line-1288">                        Storage.MySQL.USER, Storage.MySQL.PASSWORD</span>
<span class="source-line-no">1289</span><span id="line-1289">                );</span>
<span class="source-line-no">1290</span><span id="line-1290">            } else if (Storage.SQLite.USE) {</span>
<span class="source-line-no">1291</span><span id="line-1291">                File file = FileUtils.getFile(platform.getDirectory(), Storage.SQLite.DB + ".db");</span>
<span class="source-line-no">1292</span><span id="line-1292">                database = new SQLite(file);</span>
<span class="source-line-no">1293</span><span id="line-1293">            } else {</span>
<span class="source-line-no">1294</span><span id="line-1294">                LOGGER.error("No storage type is set. Disabling PlotSquared");</span>
<span class="source-line-no">1295</span><span id="line-1295">                this.platform.shutdown(); //shutdown used instead of disable because no database is set</span>
<span class="source-line-no">1296</span><span id="line-1296">                return;</span>
<span class="source-line-no">1297</span><span id="line-1297">            }</span>
<span class="source-line-no">1298</span><span id="line-1298">            DBFunc.dbManager = new SQLManager(</span>
<span class="source-line-no">1299</span><span id="line-1299">                    database,</span>
<span class="source-line-no">1300</span><span id="line-1300">                    Storage.PREFIX,</span>
<span class="source-line-no">1301</span><span id="line-1301">                    this.eventDispatcher,</span>
<span class="source-line-no">1302</span><span id="line-1302">                    this.plotListener,</span>
<span class="source-line-no">1303</span><span id="line-1303">                    this.worldConfiguration</span>
<span class="source-line-no">1304</span><span id="line-1304">            );</span>
<span class="source-line-no">1305</span><span id="line-1305">            this.plots_tmp = DBFunc.getPlots();</span>
<span class="source-line-no">1306</span><span id="line-1306">            if (getPlotAreaManager() instanceof SinglePlotAreaManager) {</span>
<span class="source-line-no">1307</span><span id="line-1307">                SinglePlotArea area = ((SinglePlotAreaManager) getPlotAreaManager()).getArea();</span>
<span class="source-line-no">1308</span><span id="line-1308">                addPlotArea(area);</span>
<span class="source-line-no">1309</span><span id="line-1309">                ConfigurationSection section = worldConfiguration.getConfigurationSection("worlds.*");</span>
<span class="source-line-no">1310</span><span id="line-1310">                if (section == null) {</span>
<span class="source-line-no">1311</span><span id="line-1311">                    section = worldConfiguration.createSection("worlds.*");</span>
<span class="source-line-no">1312</span><span id="line-1312">                }</span>
<span class="source-line-no">1313</span><span id="line-1313">                area.saveConfiguration(section);</span>
<span class="source-line-no">1314</span><span id="line-1314">                area.loadDefaultConfiguration(section);</span>
<span class="source-line-no">1315</span><span id="line-1315">            }</span>
<span class="source-line-no">1316</span><span id="line-1316">            this.clustersTmp = DBFunc.getClusters();</span>
<span class="source-line-no">1317</span><span id="line-1317">            LOGGER.info("Connection to database established. Type: {}", Storage.MySQL.USE ? "MySQL" : "SQLite");</span>
<span class="source-line-no">1318</span><span id="line-1318">        } catch (ClassNotFoundException | SQLException e) {</span>
<span class="source-line-no">1319</span><span id="line-1319">            LOGGER.error(</span>
<span class="source-line-no">1320</span><span id="line-1320">                    "Failed to open database connection ({}). Disabling PlotSquared",</span>
<span class="source-line-no">1321</span><span id="line-1321">                    Storage.MySQL.USE ? "MySQL" : "SQLite"</span>
<span class="source-line-no">1322</span><span id="line-1322">            );</span>
<span class="source-line-no">1323</span><span id="line-1323">            LOGGER.error("==== Here is an ugly stacktrace, if you are interested in those things ===");</span>
<span class="source-line-no">1324</span><span id="line-1324">            e.printStackTrace();</span>
<span class="source-line-no">1325</span><span id="line-1325">            LOGGER.error("==== End of stacktrace ====");</span>
<span class="source-line-no">1326</span><span id="line-1326">            LOGGER.error(</span>
<span class="source-line-no">1327</span><span id="line-1327">                    "Please go to the {} 'storage.yml' and configure the database correctly",</span>
<span class="source-line-no">1328</span><span id="line-1328">                    platform.pluginName()</span>
<span class="source-line-no">1329</span><span id="line-1329">            );</span>
<span class="source-line-no">1330</span><span id="line-1330">            this.platform.shutdown(); //shutdown used instead of disable because of database error</span>
<span class="source-line-no">1331</span><span id="line-1331">        }</span>
<span class="source-line-no">1332</span><span id="line-1332">    }</span>
<span class="source-line-no">1333</span><span id="line-1333"></span>
<span class="source-line-no">1334</span><span id="line-1334">    /**</span>
<span class="source-line-no">1335</span><span id="line-1335">     * Setup the default configuration.</span>
<span class="source-line-no">1336</span><span id="line-1336">     */</span>
<span class="source-line-no">1337</span><span id="line-1337">    public void setupConfig() {</span>
<span class="source-line-no">1338</span><span id="line-1338">        String lastVersionString = this.getConfig().getString("version");</span>
<span class="source-line-no">1339</span><span id="line-1339">        if (lastVersionString != null) {</span>
<span class="source-line-no">1340</span><span id="line-1340">            String[] split = lastVersionString.split("\\.");</span>
<span class="source-line-no">1341</span><span id="line-1341">            int[] lastVersion = new int[]{Integer.parseInt(split[0]), Integer.parseInt(split[1]),</span>
<span class="source-line-no">1342</span><span id="line-1342">                    Integer.parseInt(split[2])};</span>
<span class="source-line-no">1343</span><span id="line-1343">            if (checkVersion(new int[]{3, 4, 0}, lastVersion)) {</span>
<span class="source-line-no">1344</span><span id="line-1344">                Settings.convertLegacy(configFile);</span>
<span class="source-line-no">1345</span><span id="line-1345">                if (getConfig().contains("worlds")) {</span>
<span class="source-line-no">1346</span><span id="line-1346">                    ConfigurationSection worldSection =</span>
<span class="source-line-no">1347</span><span id="line-1347">                            getConfig().getConfigurationSection("worlds");</span>
<span class="source-line-no">1348</span><span id="line-1348">                    worldConfiguration.set("worlds", worldSection);</span>
<span class="source-line-no">1349</span><span id="line-1349">                    try {</span>
<span class="source-line-no">1350</span><span id="line-1350">                        worldConfiguration.save(worldsFile);</span>
<span class="source-line-no">1351</span><span id="line-1351">                    } catch (IOException e) {</span>
<span class="source-line-no">1352</span><span id="line-1352">                        LOGGER.error("Failed to save worlds.yml", e);</span>
<span class="source-line-no">1353</span><span id="line-1353">                        e.printStackTrace();</span>
<span class="source-line-no">1354</span><span id="line-1354">                    }</span>
<span class="source-line-no">1355</span><span id="line-1355">                }</span>
<span class="source-line-no">1356</span><span id="line-1356">                Settings.save(configFile);</span>
<span class="source-line-no">1357</span><span id="line-1357">            }</span>
<span class="source-line-no">1358</span><span id="line-1358">        }</span>
<span class="source-line-no">1359</span><span id="line-1359">        Settings.load(configFile);</span>
<span class="source-line-no">1360</span><span id="line-1360">        //Sets the version information for the settings.yml file</span>
<span class="source-line-no">1361</span><span id="line-1361">        try (InputStream stream = getClass().getResourceAsStream("/plugin.properties")) {</span>
<span class="source-line-no">1362</span><span id="line-1362">            try (BufferedReader br = new BufferedReader(new InputStreamReader(stream))) {</span>
<span class="source-line-no">1363</span><span id="line-1363">                String versionString = br.readLine();</span>
<span class="source-line-no">1364</span><span id="line-1364">                String commitString = br.readLine();</span>
<span class="source-line-no">1365</span><span id="line-1365">                String dateString = br.readLine();</span>
<span class="source-line-no">1366</span><span id="line-1366">                this.version = PlotVersion.tryParse(versionString, commitString, dateString);</span>
<span class="source-line-no">1367</span><span id="line-1367">            }</span>
<span class="source-line-no">1368</span><span id="line-1368">        } catch (IOException throwable) {</span>
<span class="source-line-no">1369</span><span id="line-1369">            throwable.printStackTrace();</span>
<span class="source-line-no">1370</span><span id="line-1370">        }</span>
<span class="source-line-no">1371</span><span id="line-1371">        Settings.save(configFile);</span>
<span class="source-line-no">1372</span><span id="line-1372">        config = YamlConfiguration.loadConfiguration(configFile);</span>
<span class="source-line-no">1373</span><span id="line-1373">    }</span>
<span class="source-line-no">1374</span><span id="line-1374"></span>
<span class="source-line-no">1375</span><span id="line-1375">    /**</span>
<span class="source-line-no">1376</span><span id="line-1376">     * Setup all configuration files&lt;br&gt;</span>
<span class="source-line-no">1377</span><span id="line-1377">     * - Config: settings.yml&lt;br&gt;</span>
<span class="source-line-no">1378</span><span id="line-1378">     * - Storage: storage.yml&lt;br&gt;</span>
<span class="source-line-no">1379</span><span id="line-1379">     *</span>
<span class="source-line-no">1380</span><span id="line-1380">     * @return success or not</span>
<span class="source-line-no">1381</span><span id="line-1381">     */</span>
<span class="source-line-no">1382</span><span id="line-1382">    public boolean setupConfigs() {</span>
<span class="source-line-no">1383</span><span id="line-1383">        File folder = new File(this.platform.getDirectory(), "config");</span>
<span class="source-line-no">1384</span><span id="line-1384">        if (!folder.exists() &amp;&amp; !folder.mkdirs()) {</span>
<span class="source-line-no">1385</span><span id="line-1385">            LOGGER.error("Failed to create the {} config folder. Please create it manually", this.platform.getDirectory());</span>
<span class="source-line-no">1386</span><span id="line-1386">        }</span>
<span class="source-line-no">1387</span><span id="line-1387">        try {</span>
<span class="source-line-no">1388</span><span id="line-1388">            this.worldsFile = new File(folder, "worlds.yml");</span>
<span class="source-line-no">1389</span><span id="line-1389">            if (!this.worldsFile.exists() &amp;&amp; !this.worldsFile.createNewFile()) {</span>
<span class="source-line-no">1390</span><span id="line-1390">                LOGGER.error("Could not create the worlds file. Please create 'worlds.yml' manually");</span>
<span class="source-line-no">1391</span><span id="line-1391">            }</span>
<span class="source-line-no">1392</span><span id="line-1392">            this.worldConfiguration = YamlConfiguration.loadConfiguration(this.worldsFile);</span>
<span class="source-line-no">1393</span><span id="line-1393"></span>
<span class="source-line-no">1394</span><span id="line-1394">            if (this.worldConfiguration.contains("worlds")) {</span>
<span class="source-line-no">1395</span><span id="line-1395">                if (!this.worldConfiguration.contains("configuration_version") || (</span>
<span class="source-line-no">1396</span><span id="line-1396">                        !this.worldConfiguration.getString("configuration_version")</span>
<span class="source-line-no">1397</span><span id="line-1397">                                .equalsIgnoreCase(LegacyConverter.CONFIGURATION_VERSION) &amp;&amp; !this.worldConfiguration</span>
<span class="source-line-no">1398</span><span id="line-1398">                                .getString("configuration_version").equalsIgnoreCase("v5"))) {</span>
<span class="source-line-no">1399</span><span id="line-1399">                    // Conversion needed</span>
<span class="source-line-no">1400</span><span id="line-1400">                    LOGGER.info("A legacy configuration file was detected. Conversion will be attempted.");</span>
<span class="source-line-no">1401</span><span id="line-1401">                    try {</span>
<span class="source-line-no">1402</span><span id="line-1402">                        com.google.common.io.Files</span>
<span class="source-line-no">1403</span><span id="line-1403">                                .copy(this.worldsFile, new File(folder, "worlds.yml.old"));</span>
<span class="source-line-no">1404</span><span id="line-1404">                        LOGGER.info("A copy of worlds.yml has been saved in the file worlds.yml.old");</span>
<span class="source-line-no">1405</span><span id="line-1405">                        final ConfigurationSection worlds =</span>
<span class="source-line-no">1406</span><span id="line-1406">                                this.worldConfiguration.getConfigurationSection("worlds");</span>
<span class="source-line-no">1407</span><span id="line-1407">                        final LegacyConverter converter = new LegacyConverter(worlds);</span>
<span class="source-line-no">1408</span><span id="line-1408">                        converter.convert();</span>
<span class="source-line-no">1409</span><span id="line-1409">                        this.worldConfiguration.set("worlds", worlds);</span>
<span class="source-line-no">1410</span><span id="line-1410">                        this.setConfigurationVersion(LegacyConverter.CONFIGURATION_VERSION);</span>
<span class="source-line-no">1411</span><span id="line-1411">                        LOGGER.info(</span>
<span class="source-line-no">1412</span><span id="line-1412">                                "The conversion has finished. PlotSquared will now be disabled and the new configuration file will be used at next startup. Please review the new worlds.yml file. Please note that schematics will not be converted, as we are now using WorldEdit to handle schematics. You need to re-generate the schematics.");</span>
<span class="source-line-no">1413</span><span id="line-1413">                    } catch (final Exception e) {</span>
<span class="source-line-no">1414</span><span id="line-1414">                        LOGGER.error("Failed to convert the legacy configuration file. See stack trace for information.", e);</span>
<span class="source-line-no">1415</span><span id="line-1415">                    }</span>
<span class="source-line-no">1416</span><span id="line-1416">                    // Disable plugin</span>
<span class="source-line-no">1417</span><span id="line-1417">                    this.platform.shutdown();</span>
<span class="source-line-no">1418</span><span id="line-1418">                    return false;</span>
<span class="source-line-no">1419</span><span id="line-1419">                }</span>
<span class="source-line-no">1420</span><span id="line-1420">            } else {</span>
<span class="source-line-no">1421</span><span id="line-1421">                this.worldConfiguration.set("configuration_version", LegacyConverter.CONFIGURATION_VERSION);</span>
<span class="source-line-no">1422</span><span id="line-1422">            }</span>
<span class="source-line-no">1423</span><span id="line-1423">        } catch (IOException ignored) {</span>
<span class="source-line-no">1424</span><span id="line-1424">            LOGGER.error("Failed to save worlds.yml");</span>
<span class="source-line-no">1425</span><span id="line-1425">        }</span>
<span class="source-line-no">1426</span><span id="line-1426">        try {</span>
<span class="source-line-no">1427</span><span id="line-1427">            this.configFile = new File(folder, "settings.yml");</span>
<span class="source-line-no">1428</span><span id="line-1428">            if (!this.configFile.exists() &amp;&amp; !this.configFile.createNewFile()) {</span>
<span class="source-line-no">1429</span><span id="line-1429">                LOGGER.error("Could not create the settings file. Please create 'settings.yml' manually");</span>
<span class="source-line-no">1430</span><span id="line-1430">            }</span>
<span class="source-line-no">1431</span><span id="line-1431">            this.config = YamlConfiguration.loadConfiguration(this.configFile);</span>
<span class="source-line-no">1432</span><span id="line-1432">            setupConfig();</span>
<span class="source-line-no">1433</span><span id="line-1433">        } catch (IOException ignored) {</span>
<span class="source-line-no">1434</span><span id="line-1434">            LOGGER.error("Failed to save settings.yml");</span>
<span class="source-line-no">1435</span><span id="line-1435">        }</span>
<span class="source-line-no">1436</span><span id="line-1436">        try {</span>
<span class="source-line-no">1437</span><span id="line-1437">            this.storageFile = new File(folder, "storage.yml");</span>
<span class="source-line-no">1438</span><span id="line-1438">            if (!this.storageFile.exists() &amp;&amp; !this.storageFile.createNewFile()) {</span>
<span class="source-line-no">1439</span><span id="line-1439">                LOGGER.error("Could not create the storage settings file. Please create 'storage.yml' manually");</span>
<span class="source-line-no">1440</span><span id="line-1440">            }</span>
<span class="source-line-no">1441</span><span id="line-1441">            YamlConfiguration.loadConfiguration(this.storageFile);</span>
<span class="source-line-no">1442</span><span id="line-1442">            setupStorage();</span>
<span class="source-line-no">1443</span><span id="line-1443">        } catch (IOException ignored) {</span>
<span class="source-line-no">1444</span><span id="line-1444">            LOGGER.error("Failed to save storage.yml");</span>
<span class="source-line-no">1445</span><span id="line-1445">        }</span>
<span class="source-line-no">1446</span><span id="line-1446">        return true;</span>
<span class="source-line-no">1447</span><span id="line-1447">    }</span>
<span class="source-line-no">1448</span><span id="line-1448"></span>
<span class="source-line-no">1449</span><span id="line-1449">    public @NonNull String getConfigurationVersion() {</span>
<span class="source-line-no">1450</span><span id="line-1450">        return this.worldConfiguration.get("configuration_version", LegacyConverter.CONFIGURATION_VERSION)</span>
<span class="source-line-no">1451</span><span id="line-1451">                .toString();</span>
<span class="source-line-no">1452</span><span id="line-1452">    }</span>
<span class="source-line-no">1453</span><span id="line-1453"></span>
<span class="source-line-no">1454</span><span id="line-1454">    public void setConfigurationVersion(final @NonNull String newVersion) throws IOException {</span>
<span class="source-line-no">1455</span><span id="line-1455">        this.worldConfiguration.set("configuration_version", newVersion);</span>
<span class="source-line-no">1456</span><span id="line-1456">        this.worldConfiguration.save(this.worldsFile);</span>
<span class="source-line-no">1457</span><span id="line-1457">    }</span>
<span class="source-line-no">1458</span><span id="line-1458"></span>
<span class="source-line-no">1459</span><span id="line-1459">    /**</span>
<span class="source-line-no">1460</span><span id="line-1460">     * Setup the storage file (load + save missing nodes).</span>
<span class="source-line-no">1461</span><span id="line-1461">     */</span>
<span class="source-line-no">1462</span><span id="line-1462">    private void setupStorage() {</span>
<span class="source-line-no">1463</span><span id="line-1463">        Storage.load(storageFile);</span>
<span class="source-line-no">1464</span><span id="line-1464">        Storage.save(storageFile);</span>
<span class="source-line-no">1465</span><span id="line-1465">        YamlConfiguration.loadConfiguration(storageFile);</span>
<span class="source-line-no">1466</span><span id="line-1466">    }</span>
<span class="source-line-no">1467</span><span id="line-1467"></span>
<span class="source-line-no">1468</span><span id="line-1468">    /**</span>
<span class="source-line-no">1469</span><span id="line-1469">     * Show startup debug information.</span>
<span class="source-line-no">1470</span><span id="line-1470">     */</span>
<span class="source-line-no">1471</span><span id="line-1471">    private void showDebug() {</span>
<span class="source-line-no">1472</span><span id="line-1472">        if (Settings.DEBUG) {</span>
<span class="source-line-no">1473</span><span id="line-1473">            Map&lt;String, Object&gt; components = Settings.getFields(Settings.Enabled_Components.class);</span>
<span class="source-line-no">1474</span><span id="line-1474">            for (Entry&lt;String, Object&gt; component : components.entrySet()) {</span>
<span class="source-line-no">1475</span><span id="line-1475">                LOGGER.info("Key: {} | Value: {}", component.getKey(), component.getValue());</span>
<span class="source-line-no">1476</span><span id="line-1476">            }</span>
<span class="source-line-no">1477</span><span id="line-1477">        }</span>
<span class="source-line-no">1478</span><span id="line-1478">    }</span>
<span class="source-line-no">1479</span><span id="line-1479"></span>
<span class="source-line-no">1480</span><span id="line-1480">    public void forEachPlotRaw(final @NonNull Consumer&lt;Plot&gt; consumer) {</span>
<span class="source-line-no">1481</span><span id="line-1481">        for (final PlotArea area : this.getPlotAreaManager().getAllPlotAreas()) {</span>
<span class="source-line-no">1482</span><span id="line-1482">            area.getPlots().forEach(consumer);</span>
<span class="source-line-no">1483</span><span id="line-1483">        }</span>
<span class="source-line-no">1484</span><span id="line-1484">        if (this.plots_tmp != null) {</span>
<span class="source-line-no">1485</span><span id="line-1485">            for (final HashMap&lt;PlotId, Plot&gt; entry : this.plots_tmp.values()) {</span>
<span class="source-line-no">1486</span><span id="line-1486">                entry.values().forEach(consumer);</span>
<span class="source-line-no">1487</span><span id="line-1487">            }</span>
<span class="source-line-no">1488</span><span id="line-1488">        }</span>
<span class="source-line-no">1489</span><span id="line-1489">    }</span>
<span class="source-line-no">1490</span><span id="line-1490"></span>
<span class="source-line-no">1491</span><span id="line-1491">    /**</span>
<span class="source-line-no">1492</span><span id="line-1492">     * Check if the chunk uses vanilla/non-PlotSquared generation</span>
<span class="source-line-no">1493</span><span id="line-1493">     *</span>
<span class="source-line-no">1494</span><span id="line-1494">     * @param world            World name</span>
<span class="source-line-no">1495</span><span id="line-1495">     * @param chunkCoordinates Chunk coordinates</span>
<span class="source-line-no">1496</span><span id="line-1496">     * @return {@code true} if the chunk uses non-standard generation, {@code false} if not</span>
<span class="source-line-no">1497</span><span id="line-1497">     */</span>
<span class="source-line-no">1498</span><span id="line-1498">    public boolean isNonStandardGeneration(</span>
<span class="source-line-no">1499</span><span id="line-1499">            final @NonNull String world,</span>
<span class="source-line-no">1500</span><span id="line-1500">            final @NonNull BlockVector2 chunkCoordinates</span>
<span class="source-line-no">1501</span><span id="line-1501">    ) {</span>
<span class="source-line-no">1502</span><span id="line-1502">        final Location location = Location.at(world, chunkCoordinates.getBlockX() &lt;&lt; 4, 64, chunkCoordinates.getBlockZ() &lt;&lt; 4);</span>
<span class="source-line-no">1503</span><span id="line-1503">        final PlotArea area = getPlotAreaManager().getApplicablePlotArea(location);</span>
<span class="source-line-no">1504</span><span id="line-1504">        if (area == null) {</span>
<span class="source-line-no">1505</span><span id="line-1505">            return true;</span>
<span class="source-line-no">1506</span><span id="line-1506">        }</span>
<span class="source-line-no">1507</span><span id="line-1507">        return area.getTerrain() != PlotAreaTerrainType.NONE;</span>
<span class="source-line-no">1508</span><span id="line-1508">    }</span>
<span class="source-line-no">1509</span><span id="line-1509"></span>
<span class="source-line-no">1510</span><span id="line-1510">    public @NonNull YamlConfiguration getConfig() {</span>
<span class="source-line-no">1511</span><span id="line-1511">        return config;</span>
<span class="source-line-no">1512</span><span id="line-1512">    }</span>
<span class="source-line-no">1513</span><span id="line-1513"></span>
<span class="source-line-no">1514</span><span id="line-1514">    public @NonNull UUIDPipeline getImpromptuUUIDPipeline() {</span>
<span class="source-line-no">1515</span><span id="line-1515">        return this.impromptuUUIDPipeline;</span>
<span class="source-line-no">1516</span><span id="line-1516">    }</span>
<span class="source-line-no">1517</span><span id="line-1517"></span>
<span class="source-line-no">1518</span><span id="line-1518">    public @NonNull UUIDPipeline getBackgroundUUIDPipeline() {</span>
<span class="source-line-no">1519</span><span id="line-1519">        return this.backgroundUUIDPipeline;</span>
<span class="source-line-no">1520</span><span id="line-1520">    }</span>
<span class="source-line-no">1521</span><span id="line-1521"></span>
<span class="source-line-no">1522</span><span id="line-1522">    public @NonNull WorldEdit getWorldEdit() {</span>
<span class="source-line-no">1523</span><span id="line-1523">        return this.worldedit;</span>
<span class="source-line-no">1524</span><span id="line-1524">    }</span>
<span class="source-line-no">1525</span><span id="line-1525"></span>
<span class="source-line-no">1526</span><span id="line-1526">    public @NonNull File getConfigFile() {</span>
<span class="source-line-no">1527</span><span id="line-1527">        return this.configFile;</span>
<span class="source-line-no">1528</span><span id="line-1528">    }</span>
<span class="source-line-no">1529</span><span id="line-1529"></span>
<span class="source-line-no">1530</span><span id="line-1530">    public @NonNull File getWorldsFile() {</span>
<span class="source-line-no">1531</span><span id="line-1531">        return this.worldsFile;</span>
<span class="source-line-no">1532</span><span id="line-1532">    }</span>
<span class="source-line-no">1533</span><span id="line-1533"></span>
<span class="source-line-no">1534</span><span id="line-1534">    public @NonNull YamlConfiguration getWorldConfiguration() {</span>
<span class="source-line-no">1535</span><span id="line-1535">        return this.worldConfiguration;</span>
<span class="source-line-no">1536</span><span id="line-1536">    }</span>
<span class="source-line-no">1537</span><span id="line-1537"></span>
<span class="source-line-no">1538</span><span id="line-1538">    /**</span>
<span class="source-line-no">1539</span><span id="line-1539">     * Get the caption map belonging to a namespace. If none exists, a dummy</span>
<span class="source-line-no">1540</span><span id="line-1540">     * caption map will be returned.</span>
<span class="source-line-no">1541</span><span id="line-1541">     * &lt;p&gt;</span>
<span class="source-line-no">1542</span><span id="line-1542">     * You can register a caption map by calling {@link #registerCaptionMap(String, CaptionMap)}</span>
<span class="source-line-no">1543</span><span id="line-1543">     * &lt;/p&gt;</span>
<span class="source-line-no">1544</span><span id="line-1544">     *</span>
<span class="source-line-no">1545</span><span id="line-1545">     * @param namespace Namespace</span>
<span class="source-line-no">1546</span><span id="line-1546">     * @return Map instance</span>
<span class="source-line-no">1547</span><span id="line-1547">     */</span>
<span class="source-line-no">1548</span><span id="line-1548">    public @NonNull CaptionMap getCaptionMap(final @NonNull String namespace) {</span>
<span class="source-line-no">1549</span><span id="line-1549">        return this.captionMaps.computeIfAbsent(</span>
<span class="source-line-no">1550</span><span id="line-1550">                namespace.toLowerCase(Locale.ENGLISH),</span>
<span class="source-line-no">1551</span><span id="line-1551">                missingNamespace -&gt; new DummyCaptionMap()</span>
<span class="source-line-no">1552</span><span id="line-1552">        );</span>
<span class="source-line-no">1553</span><span id="line-1553">    }</span>
<span class="source-line-no">1554</span><span id="line-1554"></span>
<span class="source-line-no">1555</span><span id="line-1555">    /**</span>
<span class="source-line-no">1556</span><span id="line-1556">     * Register a caption map. The namespace needs to be equal to the namespace used for</span>
<span class="source-line-no">1557</span><span id="line-1557">     * the {@link TranslatableCaption}s inside the map.</span>
<span class="source-line-no">1558</span><span id="line-1558">     *</span>
<span class="source-line-no">1559</span><span id="line-1559">     * @param namespace  Namespace</span>
<span class="source-line-no">1560</span><span id="line-1560">     * @param captionMap Map instance</span>
<span class="source-line-no">1561</span><span id="line-1561">     */</span>
<span class="source-line-no">1562</span><span id="line-1562">    public void registerCaptionMap(</span>
<span class="source-line-no">1563</span><span id="line-1563">            final @NonNull String namespace,</span>
<span class="source-line-no">1564</span><span id="line-1564">            final @NonNull CaptionMap captionMap</span>
<span class="source-line-no">1565</span><span id="line-1565">    ) {</span>
<span class="source-line-no">1566</span><span id="line-1566">        if (namespace.equalsIgnoreCase(TranslatableCaption.DEFAULT_NAMESPACE)) {</span>
<span class="source-line-no">1567</span><span id="line-1567">            throw new IllegalArgumentException("Cannot replace default caption map");</span>
<span class="source-line-no">1568</span><span id="line-1568">        }</span>
<span class="source-line-no">1569</span><span id="line-1569">        this.captionMaps.put(namespace.toLowerCase(Locale.ENGLISH), captionMap);</span>
<span class="source-line-no">1570</span><span id="line-1570">    }</span>
<span class="source-line-no">1571</span><span id="line-1571"></span>
<span class="source-line-no">1572</span><span id="line-1572">    public @NonNull EventDispatcher getEventDispatcher() {</span>
<span class="source-line-no">1573</span><span id="line-1573">        return this.eventDispatcher;</span>
<span class="source-line-no">1574</span><span id="line-1574">    }</span>
<span class="source-line-no">1575</span><span id="line-1575"></span>
<span class="source-line-no">1576</span><span id="line-1576">    public @NonNull PlotListener getPlotListener() {</span>
<span class="source-line-no">1577</span><span id="line-1577">        return this.plotListener;</span>
<span class="source-line-no">1578</span><span id="line-1578">    }</span>
<span class="source-line-no">1579</span><span id="line-1579"></span>
<span class="source-line-no">1580</span><span id="line-1580">    /**</span>
<span class="source-line-no">1581</span><span id="line-1581">     * Get if the {@link PlatformReadyEvent} has been sent by WorldEdit. There is no way to query this within WorldEdit itself.</span>
<span class="source-line-no">1582</span><span id="line-1582">     */</span>
<span class="source-line-no">1583</span><span id="line-1583">    public boolean isWeInitialised() {</span>
<span class="source-line-no">1584</span><span id="line-1584">        return weInitialised;</span>
<span class="source-line-no">1585</span><span id="line-1585">    }</span>
<span class="source-line-no">1586</span><span id="line-1586"></span>
<span class="source-line-no">1587</span><span id="line-1587">    /**</span>
<span class="source-line-no">1588</span><span id="line-1588">     * Different ways of sorting {@link Plot plots}</span>
<span class="source-line-no">1589</span><span id="line-1589">     */</span>
<span class="source-line-no">1590</span><span id="line-1590">    public enum SortType {</span>
<span class="source-line-no">1591</span><span id="line-1591">        /**</span>
<span class="source-line-no">1592</span><span id="line-1592">         * Sort plots by their creation, using their index in the database</span>
<span class="source-line-no">1593</span><span id="line-1593">         */</span>
<span class="source-line-no">1594</span><span id="line-1594">        CREATION_DATE,</span>
<span class="source-line-no">1595</span><span id="line-1595">        /**</span>
<span class="source-line-no">1596</span><span id="line-1596">         * Sort plots by their creation timestamp</span>
<span class="source-line-no">1597</span><span id="line-1597">         */</span>
<span class="source-line-no">1598</span><span id="line-1598">        CREATION_DATE_TIMESTAMP,</span>
<span class="source-line-no">1599</span><span id="line-1599">        /**</span>
<span class="source-line-no">1600</span><span id="line-1600">         * Sort plots by when they were last modified</span>
<span class="source-line-no">1601</span><span id="line-1601">         */</span>
<span class="source-line-no">1602</span><span id="line-1602">        LAST_MODIFIED,</span>
<span class="source-line-no">1603</span><span id="line-1603">        /**</span>
<span class="source-line-no">1604</span><span id="line-1604">         * Sort plots based on their distance from the origin of the world</span>
<span class="source-line-no">1605</span><span id="line-1605">         */</span>
<span class="source-line-no">1606</span><span id="line-1606">        DISTANCE_FROM_ORIGIN</span>
<span class="source-line-no">1607</span><span id="line-1607">    }</span>
<span class="source-line-no">1608</span><span id="line-1608"></span>
<span class="source-line-no">1609</span><span id="line-1609">    private final class WEPlatformReadyListener {</span>
<span class="source-line-no">1610</span><span id="line-1610"></span>
<span class="source-line-no">1611</span><span id="line-1611">        @SuppressWarnings("unused")</span>
<span class="source-line-no">1612</span><span id="line-1612">        @Subscribe(priority = EventHandler.Priority.VERY_EARLY)</span>
<span class="source-line-no">1613</span><span id="line-1613">        public void onPlatformReady(PlatformReadyEvent event) {</span>
<span class="source-line-no">1614</span><span id="line-1614">            weInitialised = true;</span>
<span class="source-line-no">1615</span><span id="line-1615">            WorldEdit.getInstance().getEventBus().unregister(WEPlatformReadyListener.this);</span>
<span class="source-line-no">1616</span><span id="line-1616">        }</span>
<span class="source-line-no">1617</span><span id="line-1617"></span>
<span class="source-line-no">1618</span><span id="line-1618">    }</span>
<span class="source-line-no">1619</span><span id="line-1619"></span>
<span class="source-line-no">1620</span><span id="line-1620">}</span>




























































</pre>
</div>
</main>
</body>
</html>
